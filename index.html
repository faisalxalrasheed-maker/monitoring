
<html>
<head>
  <meta charset="utf-8" />
  <title>URL Monitor Pro (Secure) - Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --primary: #2196F3; --success: #2e7d32; --danger: #d32f2f; --warn: #f9a825; --muted: #666; --bg: #e3f2fd; --panel: #fff; --chip: #f5f5f5; --border: #eee; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: var(--bg); color: #333; margin: 0; }
    .wrap { max-width: 1100px; margin: 0 auto; background: var(--panel); padding: 20px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
    h1 { text-align: center; color: var(--primary); margin: 0 0 10px; }
    .actions { text-align: center; margin: 18px 0 24px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button { cursor: pointer; }
    .btn { padding: 12px 16px; border: none; font-size: 14px; border-radius: 6px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-green { background: #2e7d32; color: #fff; }
    .btn-purple { background: #6a1b9a; color: #fff; }
    .btn-red { background: #d32f2f; color: #fff; }
    .btn-gray { background: #9e9e9e; color: #fff; }
    .btn-orange { background: #f57c00; color: #fff; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 10px 0 20px; }
    .stat { background: var(--chip); padding: 14px; border-radius: 10px; text-align: center; }
    .stat .label { color: var(--muted); }
    .stat .value { font-size: 24px; font-weight: bold; }
    .grid { display: grid; gap: 12px; }
    .row { display:flex; align-items:center; gap:12px; padding:12px; border:1px solid var(--border); border-radius:10px; }
    .dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
    .url { font-weight:600; word-break: break-all; }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .timeline { width: 240px; height: 28px; }
    .chip { background:#eef7ff; color:#1976d2; border:1px solid #cfe8ff; padding:3px 6px; border-radius:999px; font-size:11px; font-weight:600; }
    .chip-warning { background:#fff3e0; color:#f57c00; border:1px solid #ffe0b2; }
    .chip-danger { background:#ffebee; color:#d32f2f; border:1px solid #ffcdd2; }
    .chip-success { background:#e8f5e8; color:#2e7d32; border:1px solid #c8e6c9; }
    .section { background:#f9f9f9; padding: 16px; border-radius: 10px; margin-top:20px; }
    .small { font-size: 12px; color: var(--muted); }
    .danger { color: var(--danger); }
    .success { color: var(--success); }
    .warn { color: var(--warn); }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 100; }
    .modal { background:#fff; width: 640px; max-width: 92vw; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; max-height: 85vh; }
    .modal header { padding:12px 16px; border-bottom:1px solid var(--border); font-weight:700; flex-shrink: 0; }
    .modal .body { padding:14px 16px; overflow-y: auto; }
    .modal .rowx { display:grid; grid-template-columns: 100px 1fr; gap:10px; align-items:center; margin-bottom: 12px; }
    .modal .rowx:last-child { margin-bottom: 0; }
    .modal .rowx input, .modal .rowx select { width: 100%; padding:8px; border:1px solid #ddd; border-radius:6px; }
    .modal footer { display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--border); flex-shrink: 0; }
    #inspectorModal .body label { display: block; padding: 8px; border-radius: 6px; cursor: pointer; }
    #inspectorModal .body label:hover { background: #f0f0f0; }
    #inspectorResults .result-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; font-size: 14px; }
    #inspectorResults .result-row .btn { padding: 4px 10px; font-size: 12px; }
    #appContainer { display: none; }
    #loginModal { display: flex; }
    .tab-container { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
    .tab { padding: 10px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: var(--primary); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .alert-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
    .btn-with-badge { position: relative; }
    .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center; gap: 10px; max-width: 400px; }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.warning { border-left: 4px solid var(--warn); }
    .notification.error { border-left: 4px solid var(--danger); }
    .notification-close { background: none; border: none; font-size: 16px; cursor: pointer; margin-left: auto; }
    @media (max-width: 600px) { .row { flex-wrap: wrap; } .right { width: 100%; justify-content: flex-end; } .timeline { display:none; } }
  </style>
</head>
<body>

<!-- Login Screen (simplified for this demo) -->
<div id="loginModal" class="modal-backdrop" style="display:none;">
  <div class="modal" style="width: 380px;">
    <header>Login to URL Monitor</header>
    <div class="body">
      <div class="rowx" style="grid-template-columns: 100px 1fr;"><label for="username">Username</label><input id="username" type="text" /></div>
      <div class="rowx" style="grid-template-columns: 100px 1fr;"><label for="password">Password</label><input id="password" type="password" /></div>
      <p id="loginError" class="danger" style="text-align:center; margin:0; display:none;"></p>
    </div>
    <footer>
      <button class="btn btn-primary" style="width:100%;" onclick="handleLogin()">Login</button>
    </footer>
  </div>
</div>

<!-- Main Application -->
<div id="appContainer">
  <div class="wrap">
    <h1>üîç URL Monitor Pro</h1>

    <div class="actions">
      <button class="btn btn-green" onclick="addURL()">+ Add URL</button>
      <button class="btn btn-primary" onclick="showSettings()">‚öôÔ∏è Settings</button>
      <button class="btn btn-purple" onclick="showInspector()">üîé Auto Inspector</button>
      <button class="btn btn-orange btn-with-badge" onclick="showAlerts()">üîî Alerts<div id="alertBadge" class="alert-badge" style="display:none;">0</div></button>
      <button class="btn btn-gray" onclick="checkAll()">‚ñ∂Ô∏è Check All Now</button>
      <button class="btn btn-red" onclick="handleLogout()">üîí Logout</button>
    </div>

    <div class="stats">
      <div class="stat"><div class="label">Total</div><div class="value" id="total">0</div></div>
      <div class="stat"><div class="label">Online</div><div class="value success" id="online">0</div></div>
      <div class="stat"><div class="label">Offline</div><div class="value danger" id="offline">0</div></div>
      <div class="stat"><div class="label">SSL Issues</div><div class="value warn" id="sslIssues">0</div></div>
      <div class="stat"><div class="label">24h Uptime</div><div class="value" id="uptime24">0%</div></div>
      <div class="stat"><div class="label">Avg RT (24h)</div><div class="value" id="avgRt24">‚Äî</div></div>
    </div>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('monitoring')">Monitoring</div>
      <div class="tab" onclick="switchTab('alerts')">Alert History</div>
      <div class="tab" onclick="switchTab('export')">Export Data</div>
    </div>

    <div id="monitoringTab" class="tab-content active">
      <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0;">Monitored URLs</h3>
          <div class="small">History retained for last 24 hours</div>
        </div>
        <div id="urlList" class="grid">No URLs added yet</div>
      </div>
    </div>

    <div id="alertsTab" class="tab-content" aria-label="Alerts">
      <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0;">Alert History</h3>
          <button class="btn btn-gray" onclick="clearAlerts()">Clear All</button>
        </div>
        <div id="alertList" class="grid">No alerts yet</div>
      </div>
    </div>

    <div id="exportTab" class="tab-content" aria-label="Export">
      <div class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0;">Export Monitoring Data</h3>
        </div>
        <div style="margin-bottom: 16px;">
          <label><input type="radio" name="exportFormat" value="csv" checked> CSV Format</label>
          <label style="margin-left: 16px;"><input type="radio" name="exportFormat" value="json"> JSON Format</label>
        </div>
        <button class="btn btn-primary" onclick="exportData()">Export Data</button>
        <div id="exportResult" style="margin-top: 16px;"></div>
      </div>
    </div>

  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-backdrop" onclick="this.style.display='none'">
  <div class="modal" role="dialog" onclick="event.stopPropagation()">
    <header>Settings</header>
    <div class="body">
      <div class="rowx" style="grid-template-columns: 170px 1fr;">
        <label>Default Check Interval</label>
        <select id="defaultInterval" style="width:100%;">
          <option value="30000">30 seconds</option>
          <option value="60000" selected>1 minute</option>
          <option value="300000">5 minutes</option>
        </select>
      </div>
      <div class="rowx" style="grid-template-columns: 170px 1fr;">
        <label>Fetch Timeout</label>
        <input id="defaultTimeout" type="number" min="1000" step="500" value="8000" style="width:100%;" />
      </div>
      <div class="rowx" style="grid-template-columns: 170px 1fr;">
        <label>API Endpoint (SSL info)</label>
        <input id="sslInfoApi" type="url" placeholder="https://example.com/ssl/info" style="width:100%;" />
      </div>
    </div>
    <footer>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </footer>
  </div>
</div>

<!-- Inspector Modal (simplified) -->
<div id="inspectorModal" class="modal-backdrop" onclick="this.style.display='none'">
  <div class="modal" role="dialog" onclick="event.stopPropagation()">
    <header>Auto Inspector</header>
    <div class="body">
      <div class="rowx" style="grid-template-columns: 120px 1fr;">
        <label>Target URL</label>
        <input id="inspectorTarget" type="url" placeholder="https://example.com" style="width:100%;" />
      </div>
      <div id="inspectorResults" class="section" style="padding:12px;">
        <div class="result-row"><span>Certificate Expiry</span><span id="inspectorExpiry" class="muted">‚Äî</span></div>
        <div class="result-row"><span>DNS Resolution</span><span id="inspectorDns" class="muted">‚Äî</span></div>
        <div class="result-row"><span>Response Time</span><span id="inspectorRt" class="muted">‚Äî</span></div>
      </div>
      <div id="inspectorNote" class="small" style="margin-top:6px; color:#555;">Note: Browser security may limit TLS details. This is best-effort.</div>
    </div>
    <footer>
      <button class="btn btn-gray" onclick="runInspector()">Run Inspector</button>
    </footer>
  </div>
</div>

<!-- Minimal inline script with fixes -->
<script>
  // Simple in-memory data
  let urls = [];
  let alerts = [];
  let currentTab = 'monitoring';
  let settings = {
    interval: 60000,
    timeout: 8000,
    sslInfoApi: ''
  };

  // Helpers
  function formatDays(n) {
    if (Number.isNaN(n) || n == null) return 'Unknown';
    if (n < 0) return 'Expired';
    if (n === 0) return '0 days';
    return Math.floor(n) + ' day' + (Math.floor(n) === 1 ? '' : 's');
  }

  function daysUntilExpiry(expiryDate) {
    if (!expiryDate) return NaN;
    const now = new Date();
    const diff = new Date(expiryDate) - now;
    const days = diff / (1000 * 60 * 60 * 24);
    return days;
  }

  // UI helpers
  function $(sel, root=document) { return root.querySelector(sel); }
  function $each(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }

  function renderURLList() {
    const list = document.getElementById('urlList');
    list.innerHTML = '';
    if (urls.length === 0) {
      list.innerHTML = '<div class="row" style="justify-content:center; color:var(--muted);">No URLs added yet</div>';
      updateTotals();
      return;
    }
    urls.forEach((u, idx) => {
      const row = document.createElement('div');
      row.className = 'row';
      // status dot
      const dot = document.createElement('span');
      dot.className = 'dot';
      dot.style.background = u.status === 'online' ? 'var(--success)' : (u.status === 'offline' ? 'var(--danger)' : '#999');
      row.appendChild(dot);

      // URL text
      const urlEl = document.createElement('div');
      urlEl.innerHTML = '<span class="url">' + escapeHtml(u.url) + '</span>';
      const sub = document.createElement('div');
      sub.className = 'sub';
      sub.textContent = 'Last checked: ' + (u.lastChecked ? new Date(u.lastChecked).toLocaleString() : 'never') +
        ' ‚Ä¢ Status: ' + (u.status || 'unknown');
      const wrap = document.createElement('div');
      wrap.style.display = 'grid';
      wrap.style.gap = '4px';
      wrap.appendChild(urlEl);
      wrap.appendChild(sub);
      row.appendChild(wrap);

      // Right actions
      const right = document.createElement('div');
      right.className = 'right';
      const checkBtn = document.createElement('button');
      checkBtn.className = 'btn btn-gray';
      checkBtn.textContent = 'Check Now';
      checkBtn.onclick = () => checkURL(u);
      right.appendChild(checkBtn);

      const del = document.createElement('button');
      del.className = 'btn btn-red';
      del.textContent = 'Remove';
      del.onclick = () => removeURL(idx);
      right.appendChild(del);

      row.appendChild(right);
      list.appendChild(row);
    });
    updateTotals();
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function updateTotals() {
    const total = urls.length;
    const online = urls.filter(u => u.status === 'online').length;
    const offline = urls.filter(u => u.status === 'offline').length;
    document.getElementById('total').textContent = total;
    document.getElementById('online').textContent = online;
    document.getElementById('offline').textContent = offline;
    // SSL issues: count items with sslOK === false
    const sslIssues = urls.filter(u => u.sslOK === false).length;
    document.getElementById('sslIssues').textContent = sslIssues;
  }

  // Core logic
  async function checkURL(u) {
    const { url } = u;
    // Respect simple approach: fetch with timeout
    let status = 'offline';
    let rt = null;
    const start = performance.now();
    try {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), settings.timeout);
      const res = await fetch(url, { method: 'HEAD', mode: 'cors', cache: 'no-store', signal: controller.signal });
      clearTimeout(id);
      rt = performance.now() - start;
      // Consider 2xx/3xx as online
      if (res.ok || (res.status >= 200 && res.status < 400)) {
        status = 'online';
      } else {
        status = 'offline';
      }
      // SSL status best-effort: if a header X-SSL-Expiry exists, use it; else try to infer from HTTPS
      const sslHeader = res.headers.get('X-SSL-Expiry') || res.headers.get('X-TLS-Expiry');
      if (sslHeader) {
        u.sslExpiry = sslHeader;
        const days = daysUntilExpiry(sslHeader);
        u.sslDaysLeft = isNaN(days) ? NaN : days;
        u.sslOK = u.sslDaysLeft > 0;
      } else {
        // If we can detect that the URL is HTTPS and response obtained, assume SSL OK for UI purposes
        try {
          const urlObj = new URL(url);
          if (urlObj.protocol === 'https:') {
            u.sslOK = true;
            u.sslDaysLeft = NaN;
            u.sslExpiry = '';
          } else {
            u.sslOK = false;
            u.sslDaysLeft = NaN;
            u.sslExpiry = '';
          }
        } catch {
          u.sslOK = false;
          u.sslDaysLeft = NaN;
          u.sslExpiry = '';
        }
      }
      // record last check
      u.lastChecked = Date.now();
      u.status = status;
      u.rtMs = Math.round(rt);
    } catch (e) {
      // timeout or network error
      u.status = 'offline';
      u.lastChecked = Date.now();
      u.rtMs = null;
      u.sslOK = false;
      u.sslDaysLeft = NaN;
      u.sslExpiry = '';
    }
    renderURLList();
  }

  async function checkAll() {
    for (const u of urls) {
      await checkURL(u);
    }
  }

  function addURL() {
    const url = prompt('Enter URL to monitor (include http/https):', 'https://example.com');
    if (!url) return;
    if (!/^https?:\/\//i.test(url)) {
      alert('Please include http:// or https://');
      return;
    }
    const entry = {
      url,
      status: 'offline',
      lastChecked: null,
      rtMs: null,
      sslOK: false,
      sslDaysLeft: NaN,
      sslExpiry: ''
    };
    urls.push(entry);
    renderURLList();
    // auto-check the new URL
    checkURL(entry);
  }

  function removeURL(index) {
    if (!confirm('Remove this URL from monitoring?')) return;
    urls.splice(index, 1);
    renderURLList();
  }

  function clearAlerts() {
    alerts = [];
    renderAlerts();
  }

  function renderAlerts() {
    const el = document.getElementById('alertList');
    el.innerHTML = '';
    if (alerts.length === 0) {
      el.innerHTML = '<div class="row" style="justify-content:center; color:var(--muted);">No alerts yet</div>';
      return;
    }
    alerts.forEach(a => {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = '<div>' + escapeHtml(a.message) + '</div><div class="sub">' + new Date(a.time).toLocaleString() + '</div>';
      el.appendChild(row);
    });
  }

  function showSettings() {
    document.getElementById('settingsModal').style.display = 'flex';
  }

  function saveSettings() {
    const int = parseInt(document.getElementById('defaultInterval').value, 10);
    const to = parseInt(document.getElementById('defaultTimeout').value, 10);
    settings.interval = Number.isFinite(int) ? int : 60000;
    settings.timeout = Number.isFinite(to) ? to : 8000;
    settings.sslInfoApi = document.getElementById('sslInfoApi').value || '';
    document.getElementById('settingsModal').style.display = 'none';
  }

  function switchTab(tab) {
    currentTab = tab;
    // toggle tab-content visibility
    document.querySelectorAll('.tab').forEach((t, i) => {
      t.classList.toggle('active', t.textContent.trim().toLowerCase() === tab);
    });
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    if (tab === 'monitoring') document.getElementById('monitoringTab').classList.add('active');
    else if (tab === 'alerts') document.getElementById('alertsTab').classList.add('active');
    else if (tab === 'export') document.getElementById('exportTab').classList.add('active');
  }

  function exportData() {
    // Simple CSV export of urls with last status
    const rows = [['URL', 'Status', 'LastChecked', 'RT(ms)', 'SSL Expiry', 'SSL Days Left', 'SSL OK'].join(',')];
    for (const u of urls) {
      rows.push([
        '"' + u.url.replace(/"/g, '""') + '"',
        u.status || '',
        u.lastChecked ? new Date(u.lastChecked).toISOString() : '',
        u.rtMs != null ? u.rtMs : '',
        (u.sslExpiry || '').toString(),
        (!Number.isNaN(u.sslDaysLeft) ? u.sslDaysLeft : ''),
        u.sslOK != null ? (u.sslOK ? 'true' : 'false') : ''
      ].join(','));
    }
    const csv = rows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'url-monitor-export.csv';
    a.click();
    URL.revokeObjectURL(a.href);
    document.getElementById('exportResult').textContent = 'Exported ' + urls.length + ' URL(s) to CSV.';
  }

  // Inspector (best-effort)
  function showInspector() {
    document.getElementById('inspectorResults').innerHTML = '';
    document.getElementById('inspectorModal').style.display = 'flex';
  }

  async function runInspector() {
    const target = document.getElementById('inspectorTarget').value;
    if (!target) return;
    const expiryEl = document.getElementById('inspectorExpiry');
    const dnsEl = document.getElementById('inspectorDns');
    const rtEl = document.getElementById('inspectorRt');
    expiryEl.textContent = 'Checking...';
    dnsEl.textContent = 'Resolving...';
    rtEl.textContent = 'Measuring...';
    let expiry = 'Unknown';
    let dns = 'Unknown';
    let rt = 'Unknown';

    // DNS: attempt to resolve by fetching a blank HEAD and timing
    try {
      const start = performance.now();
      // Use a trick: fetch a tiny resource to force DNS resolution
      await fetch(target, { method: 'HEAD', mode: 'no-cors', cache: 'no-store' });
      const t = performance.now() - start;
      rt = Math.round(t) + ' ms';
      dns = 'Resolved';
      expiry = 'Unknown (TLS details not exposed in browsers)';
    } catch (e) {
      dns = 'Failed';
      rt = 'Timeout';
      expiry = 'Unknown';
    }

    expiryEl.textContent = expiry;
    dnsEl.textContent = dns;
    rtEl.textContent = rt;
  }

  // Login (dummy)
  function handleLogin() {
    // For demo, simply hide login modal
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    // Seed with a sample URL
    if (urls.length === 0) {
      urls.push({ url: 'https://example.com', status: 'offline', lastChecked: null, rtMs: null, sslOK: false, sslDaysLeft: NaN, sslExpiry: '' });
      renderURLList();
    }
  }

  function handleLogout() {
    // simple local logout
    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('loginModal').style.display = 'flex';
  }

  // Init (load from localStorage if present)
  function loadState() {
    try {
      const s = localStorage.getItem('url-monitor-state');
      if (s) {
        const data = JSON.parse(s);
        urls = data.urls || [];
        alerts = data.alerts || [];
        settings = data.settings || settings;
      }
    } catch {}
  }

  function saveState() {
    try {
      const data = { urls, alerts, settings };
      localStorage.setItem('url-monitor-state', JSON.stringify(data));
    } catch {}
  }

  // Periodic auto-check (optional)
  let intervalHandle = null;
  function startAutoCheck() {
    if (intervalHandle) clearInterval(intervalHandle);
    intervalHandle = setInterval(() => {
      checkAll();
    }, settings.interval);
  }

  // Init
  window.addEventListener('load', () => {
    // Show login for this demo
    document.getElementById('loginModal').style.display = 'flex';
    // Load any saved state
    loadState();
    renderURLList();
    renderAlerts();
  });

  // Save on unload
  window.addEventListener('beforeunload', saveState);

  // Expose globals for inline HTML bindings if any
  window.addURL = addURL;
  window.checkAll = checkAll;
  window.showSettings = showSettings;
  window.switchTab = switchTab;
  window.exportData = exportData;
  window.showAlerts = () => { alert('Alerts panel is a placeholder in this simplified build.'); renderAlerts(); };
  window.checkURL = checkURL;
  window.removeURL = removeURL;
  window.handleLogin = handleLogin;
  window.handleLogout = handleLogout;
  window.runInspector = runInspector;
  window.showInspector = showInspector;
  window.saveSettings = saveSettings;

  // Minor: update SSL expiry display in URL list after each check
  // (During renderURLList, we show sslDaysLeft if available)
</script>

</body>
</html>
