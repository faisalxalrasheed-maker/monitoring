<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>URL Monitor Pro (Secure)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --primary: #2196F3; --success: #2e7d32; --danger: #d32f2f; --warn: #f9a825; --muted: #666; --bg: #e3f2fd; --panel: #fff; --chip: #f5f5f5; --border: #eee; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: var(--bg); color: #333; margin: 0; }
    .wrap { max-width: 1100px; margin: 0 auto; background: var(--panel); padding: 20px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
    h1 { text-align: center; color: var(--primary); margin: 0 0 10px; }
    .actions { text-align: center; margin: 18px 0 24px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button { cursor: pointer; }
    .btn { padding: 12px 16px; border: none; font-size: 14px; border-radius: 6px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-green { background: #2e7d32; color: #fff; }
    .btn-purple { background: #6a1b9a; color: #fff; }
    .btn-red { background: #d32f2f; color: #fff; }
    .btn-gray { background: #9e9e9e; color: #fff; }
    .btn-orange { background: #f57c00; color: #fff; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 10px 0 20px; }
    .stat { background: var(--chip); padding: 14px; border-radius: 10px; text-align: center; }
    .stat .label { color: var(--muted); }
    .stat .value { font-size: 24px; font-weight: bold; }
    .grid { display: grid; gap: 12px; }
    .row { display:flex; align-items:center; gap:12px; padding:12px; border:1px solid var(--border); border-radius:10px; }
    .dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
    .url { font-weight:600; word-break: break-all; }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .timeline { width: 240px; height: 28px; }
    .chip { background:#eef7ff; color:#1976d2; border:1px solid #cfe8ff; padding:3px 6px; border-radius:999px; font-size:11px; font-weight:600; }
    .chip-warning { background:#fff3e0; color:#f57c00; border:1px solid #ffe0b2; }
    .chip-danger { background:#ffebee; color:#d32f2f; border:1px solid #ffcdd2; }
    .chip-success { background:#e8f5e8; color:#2e7d32; border:1px solid #c8e6c9; }
    .section { background:#f9f9f9; padding: 16px; border-radius: 10px; margin-top:20px; }
    .small { font-size: 12px; color: var(--muted); }
    .danger { color: var(--danger); }
    .success { color: var(--success); }
    .warn { color: var(--warn); }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 100; }
    .modal { background:#fff; width: 640px; max-width: 92vw; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; max-height: 85vh; }
    .modal header { padding:12px 16px; border-bottom:1px solid var(--border); font-weight:700; flex-shrink: 0; }
    .modal .body { padding:14px 16px; overflow-y: auto; }
    .modal .rowx { display:grid; grid-template-columns: 100px 1fr; gap:10px; align-items:center; margin-bottom: 12px; }
    .modal .rowx:last-child { margin-bottom: 0; }
    .modal .rowx input, .modal .rowx select { width: 100%; padding:8px; border:1px solid #ddd; border-radius:6px; }
    .modal footer { display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--border); flex-shrink: 0; }
    #inspectorModal .body label { display: block; padding: 8px; border-radius: 6px; cursor: pointer; }
    #inspectorModal .body label:hover { background: #f0f0f0; }
    #inspectorModal .body input[type="radio"] { margin-right: 8px; }
    #inspectorResults .result-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; font-size: 14px; }
    #inspectorResults .result-row .btn { padding: 4px 10px; font-size: 12px; }
    #appContainer { display: none; }
    #loginModal { display: flex; }
    .tab-container { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
    .tab { padding: 10px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: var(--primary); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .alert-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
    .btn-with-badge { position: relative; }
    .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center; gap: 10px; max-width: 400px; }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.warning { border-left: 4px solid var(--warn); }
    .notification.error { border-left: 4px solid var(--danger); }
    .notification-close { background: none; border: none; font-size: 16px; cursor: pointer; margin-left: auto; }
    @media (max-width: 600px) { .row { flex-wrap: wrap; } .right { width: 100%; justify-content: flex-end; } .timeline { display:none; } }
  </style>
</head>
<body>

<div id="loginModal" class="modal-backdrop">
    <div class="modal" style="width: 400px;">
      <header>Login to URL Monitor</header>
      <div class="body">
        <div class="rowx"><label for="username">Username</label><input id="username" type="text" /></div>
        <div class="rowx"><label for="password">Password</label><input id="password" type="password" /></div>
        <p id="loginError" class="danger" style="text-align:center; margin:0; display:none;"></p>
      </div>
      <footer>
        <button class="btn btn-primary" style="width:100%;" onclick="handleLogin()">Login</button>
      </footer>
    </div>
</div>

<div id="appContainer">
    <div class="wrap">
    <h1>üîç URL Monitor Pro</h1>

    <div class="actions">
        <button class="btn btn-green" onclick="addURL()">+ Add URL</button>
        <button class="btn btn-primary" onclick="showSettings()">‚öôÔ∏è Settings</button>
        <button class="btn btn-purple" onclick="showInspector()">üîé Auto Inspector</button>
        <button class="btn btn-orange btn-with-badge" onclick="showAlerts()">üîî Alerts<div id="alertBadge" class="alert-badge" style="display:none;">0</div></button>
        <button class="btn btn-gray" onclick="checkAll()">‚ñ∂Ô∏è Check All Now</button>
        <button class="btn btn-red" onclick="handleLogout()">üîí Logout</button>
    </div>

    <div class="stats">
        <div class="stat"><div class="label">Total</div><div class="value" id="total">0</div></div>
        <div class="stat"><div class="label">Online</div><div class="value success" id="online">0</div></div>
        <div class="stat"><div class="label">Offline</div><div class="value danger" id="offline">0</div></div>
        <div class="stat"><div class="label">SSL Issues</div><div class="value warn" id="sslIssues">0</div></div>
        <div class="stat"><div class="label">24h Uptime</div><div class="value" id="uptime24">0%</div></div>
        <div class="stat"><div class="label">Avg RT (24h)</div><div class="value" id="avgRt24">‚Äî</div></div>
    </div>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('monitoring')">Monitoring</div>
      <div class="tab" onclick="switchTab('alerts')">Alert History</div>
      <div class="tab" onclick="switchTab('export')">Export Data</div>
    </div>

    <div id="monitoringTab" class="tab-content active">
      <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <h3 style="margin:0;">Monitored URLs</h3>
              <div class="small">History retained for last 24 hours</div>
          </div>
          <div id="urlList" class="grid">No URLs added yet</div>
      </div>
    </div>

    <div id="alertsTab" class="tab-content">
      <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <h3 style="margin:0;">Alert History</h3>
              <button class="btn btn-gray" onclick="clearAlerts()">Clear All</button>
          </div>
          <div id="alertList" class="grid">No alerts yet</div>
      </div>
    </div>

    <div id="exportTab" class="tab-content">
      <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <h3 style="margin:0;">Export Monitoring Data</h3>
          </div>
          <div style="margin-bottom: 16px;">
            <label><input type="radio" name="exportFormat" value="csv" checked> CSV Format</label>
            <label style="margin-left: 16px;"><input type="radio" name="exportFormat" value="json"> JSON Format</label>
          </div>
          <button class="btn btn-primary" onclick="exportData()">Export Data</button>
          <div id="exportResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    </div>
</div>

<div id="settingsModal" class="modal-backdrop" onclick="this.style.display='none'">
  <div class="modal" role="dialog" onclick="event.stopPropagation()">
    <header>Settings</header>
    <div class="body">
      <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Check Interval (sec)</label><input id="interval" type="number" min="10" /></div>
      <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Timeout (ms)</label><input id="timeout" type="number" min="1000" /></div>
      <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Max Endpoints (Inspector)</label><input id="maxEndpoints" type="number" min="5" /></div>
      <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>SSL Check Interval (days)</label><input id="sslCheckInterval" type="number" min="1" /></div>
      <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>SSL Expiry Warning (days)</label><input id="sslWarningDays" type="number" min="1" /></div>
      <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Alert Sound</label><select id="alertSound"><option value="none">None</option><option value="beep">Beep</option><option value="bell">Bell</option></select></div>
    </div>
    <footer>
      <button class="btn btn-gray" onclick="document.getElementById('settingsModal').style.display='none'">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </footer>
  </div>
</div>

<div id="inspectorModal" class="modal-backdrop" onclick="this.style.display='none'">
    <div class="modal" role="dialog" onclick="event.stopPropagation()">
      <header>Auto Inspector</header>
      <div class="body">
        <div>
          <b>1. Select a URL to inspect for related endpoints</b>
          <div id="inspectorSourceList" class="grid" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 8px; border-radius: 8px; margin-top: 8px;"></div>
        </div>
        <div id="inspectorResults" style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
          <b>2. Found Endpoints</b>
          <div id="inspectorResultList" style="margin-top: 8px;">Select a source URL and click "Start Inspection".</div>
        </div>
      </div>
      <footer>
        <button class="btn btn-gray" onclick="document.getElementById('inspectorModal').style.display='none'">Close</button>
        <button id="startScanBtn" class="btn btn-primary" onclick="startInspectorScan()">Start Inspection</button>
      </footer>
    </div>
  </div>

<script>
  // =============== State & Persistence ===============
  const DEFAULT_SETTINGS = {
    intervalSec: 60,
    timeoutMs: 8000,
    maxInspectorEndpoints: 20,
    sslCheckInterval: 1,
    sslWarningDays: 30,
    alertSound: 'none'
  };
  const $ = (selector) => document.querySelector(selector);

  const elements = {
      appContainer: $('#appContainer'),
      login: { modal: $('#loginModal'), username: $('#username'), password: $('#password'), error: $('#loginError') },
      modals: { settings: $('#settingsModal'), inspector: $('#inspectorModal') },
      urlList: $('#urlList'),
      alertList: $('#alertList'),
      stats: { total: $('#total'), online: $('#online'), offline: $('#offline'), sslIssues: $('#sslIssues'), uptime24: $('#uptime24'), avgRt24: $('#avgRt24') },
      inputs: { interval: $('#interval'), timeout: $('#timeout'), maxEndpoints: $('#maxEndpoints'), sslCheckInterval: $('#sslCheckInterval'), sslWarningDays: $('#sslWarningDays'), alertSound: $('#alertSound') },
      inspector: { sourceList: $('#inspectorSourceList'), resultList: $('#inspectorResultList'), startBtn: $('#startScanBtn') },
      alertBadge: $('#alertBadge')
  };
  let timer = null;
  let sslTimer = null;
  let settings, urls, alerts;
  // Will be initialized after login

  const loadFromStorage = (key, fallback) => { try { return JSON.parse(localStorage.getItem(key)) || fallback; } catch { return fallback; } };
  const persistUrls = () => localStorage.setItem('ump_urls', JSON.stringify(urls));
  const persistSettings = () => localStorage.setItem('ump_settings', JSON.stringify(settings));
  const persistAlerts = () => localStorage.setItem('ump_alerts', JSON.stringify(alerts));
  
  // =============== Authentication ===============
  const CREDENTIALS = { user: 'Faisal', pass: '456456f' };
  
  function handleLogin() {
    const user = elements.login.username.value;
    const pass = elements.login.password.value;
    if (user === CREDENTIALS.user && pass === CREDENTIALS.pass) {
        sessionStorage.setItem('isAuthenticated', 'true');
        elements.login.modal.style.display = 'none';
        elements.appContainer.style.display = 'block';
        initializeApp();
    } else {
        elements.login.error.textContent = 'Invalid credentials. Please try again.';
        elements.login.error.style.display = 'block';
    }
  }

  function handleLogout() {
    sessionStorage.removeItem('isAuthenticated');
    location.reload();
  }

  // Auto-login if session is active
  if (sessionStorage.getItem('isAuthenticated') === 'true') {
    elements.login.modal.style.display = 'none';
    elements.appContainer.style.display = 'block';
    initializeApp();
  }

  // =============== Utilities ===============
  const normalizeUrl = (input) => { try { let u = (input || '').trim(); if (!u) return null; return new URL(u.startsWith('http') ? u : `https://${u}`).toString(); } catch { return null; } };
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const average = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;
  const now = () => Date.now();
  const DAY_MS = 24 * 60 * 60 * 1000;
  const prune = (arr, key) => (arr || []).filter(item => (item[key] ?? item) >= now() - DAY_MS);
  const addHistory = (item, status, rt) => {
    item.history = prune(item.history, 't');
    item.history.push({ t: now(), status, rt: typeof rt === 'number' ? rt : null });
  };
  
  // =============== Checkers ===============
  function pingFavicon(url, timeoutMs) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const start = performance.now();
      const timer = setTimeout(() => reject(new Error('Timeout')), timeoutMs);
      img.onload = () => { clearTimeout(timer); resolve({ rt: performance.now() - start }); };
      img.onerror = () => { clearTimeout(timer); reject(new Error('Image load error')); };
      try { img.src = `${new URL(url).origin}/favicon.ico?v=${now()}`; } catch (e) { reject(e); }
    });
  }

  // SSL Certificate Checker - FIXED VERSION
  async function checkSSLCertificate(url) {
    return new Promise((resolve) => {
      try {
        // NOTE: A real SSL check is not possible from client-side JavaScript
        // due to browser security restrictions. This is a simulation.
        // This version returns a fixed, predictable expiry date for demonstration.
        
        const today = new Date();
        const daysToExpiry = 85; // Using a fixed number to avoid "random" feel.
        const expiryDate = new Date(today);
        expiryDate.setDate(today.getDate() + daysToExpiry);

        resolve({
          valid: true,
          daysRemaining: daysToExpiry,
          expiryDate: expiryDate.toISOString().split('T')[0],
          issuer: "Simulated CA - Fixed"
        });
      } catch (error) {
        resolve({
          valid: false,
          daysRemaining: 0,
          expiryDate: null,
          issuer: null,
          error: error.message
        });
      }
    });
  }

  // =============== Core Logic ===============
  async function checkUrl(item) {
    try {
      const { rt } = await pingFavicon(item.url, settings.timeoutMs);
      addHistory(item, 'online', rt);

      // Check if SSL check is due
      const lastSSLCheck = item.lastSSLCheck || 0;
      const sslCheckDue = now() - lastSSLCheck > settings.sslCheckInterval * DAY_MS;
      if (sslCheckDue) {
        const sslResult = await checkSSLCertificate(item.url);
        item.sslInfo = sslResult;
        item.lastSSLCheck = now();

        // Check for SSL expiry warning
        if (sslResult.daysRemaining <= settings.sslWarningDays) {
          addAlert(item.url, 'SSL Expiry Warning',
            `SSL certificate for ${item.url} expires in ${sslResult.daysRemaining} days (${sslResult.expiryDate})`,
            'warning');
        }
      }
    } catch (error) {
      addHistory(item, 'offline', null);
      addAlert(item.url, 'Connection Error', `Failed to connect to ${item.url}: ${error.message}`, 'error');
      console.warn(`Check failed for ${item.url}:`, error.message);
    }
  }

  async function checkAll() {
    await Promise.all(urls.map(checkUrl));
    persistUrls();
    render();
  }

  const startChecking = () => {
    stopChecking();
    if (settings.intervalSec > 0) { checkAll(); timer = setInterval(checkAll, settings.intervalSec * 1000); }
  };
  const stopChecking = () => clearInterval(timer);
  
  // =============== Alert System ===============
  function addAlert(url, title, message, type = 'info') {
    const alert = {
      id: now() + Math.random(),
      timestamp: now(),
      url,
      title,
      message,
      type,
      read: false
    };
    alerts.unshift(alert);
    alerts = alerts.slice(0, 100); // Keep only last 100 alerts
    persistAlerts();
    updateAlertBadge();
    // Show notification if enabled
    if (settings.alertSound !== 'none') {
      showNotification(alert);
      playAlertSound();
    }
  }

  function updateAlertBadge() {
    const unreadCount = alerts.filter(a => !a.read).length;
    if (unreadCount > 0) {
      elements.alertBadge.textContent = unreadCount;
      elements.alertBadge.style.display = 'flex';
    } else {
      elements.alertBadge.style.display = 'none';
    }
  }

  function showNotification(alert) {
    const notification = document.createElement('div');
    notification.className = `notification ${alert.type}`;
    notification.innerHTML = `
      <div>
        <strong>${escapeHtml(alert.title)}</strong>
        <div class="small">${escapeHtml(alert.message)}</div>
      </div>
      <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  function playAlertSound() {
    // In a real implementation, you would play actual sound files
    console.log('Alert sound would play here');
  }

  function showAlerts() {
    switchTab('alerts');
    // Mark all alerts as read when viewing
    alerts.forEach(alert => alert.read = true);
    persistAlerts();
    updateAlertBadge();
    renderAlerts();
  }

  function clearAlerts() {
    if (confirm('Are you sure you want to clear all alerts?')) {
      alerts = [];
      persistAlerts();
      updateAlertBadge();
      renderAlerts();
    }
  }

  function renderAlerts() {
    if (alerts.length === 0) {
      elements.alertList.innerHTML = '<div style="text-align:center; color: var(--muted); padding: 20px 0;">No alerts yet.</div>';
      return;
    }

    elements.alertList.innerHTML = alerts.map(alert => `
      <div class="row">
        <div class="dot" style="background:${alert.type === 'error' ? 'var(--danger)' : alert.type === 'warning' ? 'var(--warn)' : 'var(--primary)'}"></div>
        <div>
          <div class="url">${escapeHtml(alert.title)}</div>
          <div class="sub">${escapeHtml(alert.message)}</div>
          <div class="sub">${new Date(alert.timestamp).toLocaleString()}</div>
        </div>
        <div class="right">
           <div class="chip ${alert.type === 'error' ? 'chip-danger' : alert.type === 'warning' ? 'chip-warning' : ''}">${alert.type}</div>
          <button onclick="deleteAlert(${alert.id})">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  function deleteAlert(id) {
    alerts = alerts.filter(alert => alert.id !== id);
    persistAlerts();
    updateAlertBadge();
    renderAlerts();
  }

  // =============== UI / Rendering ===============
  const renderTimeline = (history) => `<svg class="timeline" viewBox="0 0 96 10">${[...Array(96)].map((_, i) => {
      const entry = history.find(h => Math.floor((now() - h.t) / (15 * 60 * 1000)) === i);
      const color = !entry ? 'var(--border)' : entry.status === 'online' ? 'var(--success)' : 'var(--danger)';
      return `<rect x="${95-i}" y="0" width="1" height="10" fill="${color}" />`;
  }).join('')}</svg>`;
  
  const getSSLChipClass = (daysRemaining) => {
    if (daysRemaining <= 7) return 'chip-danger';
    if (daysRemaining <= 30) return 'chip-warning';
    return 'chip-success';
  };

  const renderUrlRow = (item) => {
    const last = item.history?.slice(-1)[0] ?? {};
    const statusClass = last.status === 'online' ? 'success' : last.status === 'offline' ? 'danger' : 'muted';
    const rtText = typeof last.rt === 'number' ? `${Math.round(last.rt)}ms` : '‚Äî';
    // SSL info - Fixed display
    let sslHtml = '';
    if (item.sslInfo && item.sslInfo.valid) {
      const sslClass = getSSLChipClass(item.sslInfo.daysRemaining);
      sslHtml = `<div class="chip ${sslClass}" title="SSL expires on ${item.sslInfo.expiryDate} (Issuer: ${item.sslInfo.issuer})">SSL: ${item.sslInfo.daysRemaining} days</div>`;
    } else if (item.sslInfo && !item.sslInfo.valid) {
      sslHtml = `<div class="chip chip-danger" title="SSL Certificate Invalid">SSL: Invalid</div>`;
    }

    return `
      <div class="row" data-url="${escapeHtml(item.url)}">
        <div class="dot" style="background:var(--${statusClass})"></div>
        <div>
          <div class="url">${escapeHtml(item.url)}</div>
          <div class="sub">Status: <b class="${statusClass}">${last.status || 'pending'}</b> | Last check: ${last.t ? new Date(last.t).toLocaleTimeString() : 'N/A'}</div>
          ${item.sslInfo && item.sslInfo.valid ? `<div class="sub">SSL: Expires on ${item.sslInfo.expiryDate} (${item.sslInfo.daysRemaining} days remaining) - ${item.sslInfo.issuer}</div>` : ''}
        </div>
        <div class="right">
          ${renderTimeline(item.history || [])}
          <div class="chip">${rtText}</div>
          ${sslHtml}
          <button onclick="deleteURL('${escapeHtml(item.url)}')">üóëÔ∏è</button>
        </div>
      </div>`;
  };

  function renderStats() {
    const onlineCount = urls.filter(u => u.history?.slice(-1)[0]?.status === 'online').length;
    const sslIssueCount = urls.filter(u => u.sslInfo && u.sslInfo.daysRemaining <= settings.sslWarningDays).length;
    const allHistory = urls.flatMap(u => u.history || []);
    const recentHistory = prune(allHistory, 't');
    const recentOnline = recentHistory.filter(h => h.status === 'online');
    const uptime = recentHistory.length ? (recentOnline.length / recentHistory.length * 100).toFixed(1) : '0.0';
    const validRts = recentOnline.map(h => h.rt).filter(rt => rt != null);
    const avgRt = average(validRts);

    elements.stats.total.textContent = urls.length;
    elements.stats.online.textContent = onlineCount;
    elements.stats.offline.textContent = urls.length - onlineCount;
    elements.stats.sslIssues.textContent = sslIssueCount;
    elements.stats.uptime24.textContent = `${uptime}%`;
    elements.stats.avgRt24.textContent = avgRt != null ? `${Math.round(avgRt)}ms` : '‚Äî';
  }

  const render = () => {
    elements.urlList.innerHTML = urls.length ? urls.map(renderUrlRow).join('') : '<div style="text-align:center; color: var(--muted); padding: 20px 0;">No URLs added yet.</div>';
    renderStats();
  };
  
  // =============== Tab Management ===============
  function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });
    // Show selected tab
    document.getElementById(`${tabName}Tab`).classList.add('active');

    // Activate selected tab button
    // event may be undefined when called programmatically ‚Äî guard it
    try { if (event && event.target) event.target.classList.add('active'); } catch (e) {}

    // Render specific tab content if needed
    if (tabName === 'alerts') {
      renderAlerts();
    }
  }

  // =============== Export Functionality ===============
  function exportData() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    let data, mimeType, filename;

    if (format === 'csv') {
      // Create CSV content
      const headers = ['URL', 'Status', 'Last Check', 'Response Time', 'SSL Days Remaining', 'SSL Expiry Date'];
      const rows = urls.map(url => [
        url.url,
        url.history?.slice(-1)[0]?.status || 'unknown',
        url.history?.slice(-1)[0]?.t ? new Date(url.history.slice(-1)[0].t).toLocaleString() : 'N/A',
        url.history?.slice(-1)[0]?.rt || 'N/A',
        url.sslInfo?.daysRemaining || 'N/A',
        url.sslInfo?.expiryDate || 'N/A'
      ]);
      data = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      mimeType = 'text/csv';
      filename = 'url-monitor-export.csv';
    } else {
      // JSON format
      data = JSON.stringify({
        exportedAt: new Date().toISOString(),
        urls: urls.map(url => ({
          url: url.url,
          status: url.history?.slice(-1)[0]?.status || 'unknown',
          lastCheck: url.history?.slice(-1)[0]?.t || null,
          responseTime: url.history?.slice(-1)[0]?.rt || null,
          sslInfo: url.sslInfo || null
        }))
      }, null, 2);
      mimeType = 'application/json';
      filename = 'url-monitor-export.json';
    }

    // Create download link
    const blob = new Blob([data], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    // Show success message
    const exportResult = document.getElementById('exportResult');
    exportResult.innerHTML = `<div class="success">Data exported successfully as ${filename}</div>`;
    setTimeout(() => {
      exportResult.innerHTML = '';
    }, 3000);
  }

  // =============== Actions / Event Handlers ===============
  function addURL(newUrl, skipCheck = false) {
    const finalUrl = typeof newUrl === 'string' ? normalizeUrl(newUrl) : normalizeUrl(prompt('Enter a new URL to monitor:'));
    if (finalUrl && !urls.some(u => u.url === finalUrl)) {
      urls.push({ url: finalUrl, history: [], spikes: [] });
      if (!skipCheck) {
        checkUrl(urls.slice(-1)[0]).then(() => { persistUrls(); render(); });
      } else {
        persistUrls(); render();
      }
      return true;
    } else if (finalUrl && typeof newUrl !== 'string') {
      alert('This URL is already being monitored.');
    }
    return false;
  }

  const deleteURL = (url) => { urls = urls.filter(u => u.url !== url); persistUrls(); render(); };

  const showSettings = () => {
    Object.keys(elements.inputs).forEach(key => {
      // map keys to settings property names
      if (key === 'maxEndpoints') elements.inputs[key].value = settings.maxInspectorEndpoints ?? DEFAULT_SETTINGS.maxInspectorEndpoints;
      else elements.inputs[key].value = settings[key] ?? DEFAULT_SETTINGS[key];
    });
    elements.modals.settings.style.display = 'flex';
  };

  function saveSettings() {
    settings.intervalSec = parseInt(elements.inputs.interval.value, 10) || 60;
    settings.timeoutMs = parseInt(elements.inputs.timeout.value, 10) || 8000;
    settings.maxInspectorEndpoints = parseInt(elements.inputs.maxEndpoints.value, 10) || 20;
    settings.sslCheckInterval = parseInt(elements.inputs.sslCheckInterval.value, 10) || 1;
    settings.sslWarningDays = parseInt(elements.inputs.sslWarningDays.value, 10) || 30;
    settings.alertSound = elements.inputs.alertSound.value;
    persistSettings();
    elements.modals.settings.style.display = 'none';
    startChecking();
  }

  function showInspector() {
    elements.inspector.sourceList.innerHTML = urls.length ? urls.map((u, i) => `
      <label><input type="radio" name="inspectorSource" value="${escapeHtml(u.url)}" ${i===0 ? 'checked' : ''}>${escapeHtml(u.url)}</label>
    `).join('') : 'Add a URL first to use as an inspection source.';
    elements.inspector.resultList.innerHTML = 'Select a source URL and click "Start Inspection".';
    elements.modals.inspector.style.display = 'flex';
  }

  // ================= Enhanced Auto Inspector (full) =================
  async function startInspectorScan() {
    const sourceRadio = document.querySelector('input[name="inspectorSource"]:checked');
    if (!sourceRadio) { alert('Please select a source URL to inspect.'); return; }

    elements.inspector.resultList.innerHTML = '<i>Inspecting... This may take a few moments.</i>';
    elements.inspector.startBtn.disabled = true;
    const sourceUrl = new URL(sourceRadio.value);
    const domainParts = sourceUrl.hostname.split('.');
    const mainDomain = domainParts.slice(Math.max(domainParts.length - 2, 0)).join('.');
    // Common candidate subdomains and paths
    const commonSubdomains = ['www', 'api', 'app', 'dev', 'blog', 'shop', 'status', 'mail', 'cdn', 'prod', 'staging', 'docs'];
    const commonPaths = ['/status', '/blog', '/api/health', '/api', '/v1', '/v2', '/api/v1', '/api/v2', '/graphql', '/health'];
    // Build initial potential list
    let potentialUrls = commonSubdomains.map(sub => `https://${sub}.${mainDomain}`);
    potentialUrls.push(`https://${mainDomain}`);
    potentialUrls = [...potentialUrls, ...commonPaths.map(path => `https://${mainDomain}${path}`)];

    // Attempt to fetch the page HTML to extract links (CORS may block; gracefully continue if so)
    try {
      const resp = await fetch(sourceUrl.href, { mode: 'cors' });
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      // Extract <a href>, <link href>, <script src>, and potential API-looking strings
      const anchors = [...doc.querySelectorAll('a[href]')].map(a => a.getAttribute('href'));
      const links = [...doc.querySelectorAll('link[href]')].map(a => a.getAttribute('href'));
      const scripts = [...doc.querySelectorAll('script[src]')].map(a => a.getAttribute('src'));

      const rawCandidates = [...anchors, ...links, ...scripts].filter(Boolean);
      rawCandidates.forEach(link => {
        try {
          let fullUrl = null;
          if (link.startsWith('http')) {
            fullUrl = link;
          } else if (link.startsWith('//')) {
            fullUrl = `${sourceUrl.protocol}${link}`;
          } else if (link.startsWith('/')) {
            fullUrl = `${sourceUrl.origin}${link}`;
          } else if (link.startsWith('api') || link.startsWith('v1') || link.startsWith('v2') || link.includes('/api/')) {
            // relative API-like path
            fullUrl = `${sourceUrl.origin}/${link}`.replace(/([^:]\/)\/+/g, '$1');
          }
          if (fullUrl && fullUrl.includes(mainDomain)) {
            potentialUrls.push(fullUrl);
          }
        } catch (e) {
          // ignore malformed links
        }
      });
      // Additionally scan inline scripts / text for common API patterns like "/api/..." or "/v1/..."
      const bodyText = doc.body ? doc.body.innerText || '' : '';
      const apiMatches = [...new Set((bodyText.match(/\/api\/[a-zA-Z0-9\/\-_\.?&=]*/g) || []).concat(bodyText.match(/\/v[0-9]+\/[a-zA-Z0-9\/\-_\.?&=]*/g) || []))];
      apiMatches.forEach(p => {
        try {
          let candidate = p;
          if (!candidate.startsWith('http')) candidate = `${sourceUrl.origin}${candidate}`;
          if (candidate.includes(mainDomain)) potentialUrls.push(candidate);
        } catch {}
      });
    } catch (err) {
      // Could be blocked by CORS or other network errors ‚Äî we continue with heuristics
      console.warn('Failed to fetch/parse main page (CORS or network issue):', err && err.message ? err.message : err);
    }

    // Normalize, dedupe and filter out existing monitored URLs
    let urlsToTest = [...new Set(potentialUrls.map(u => normalizeUrl(u)).filter(u => u && !urls.some(existing => existing.url === u)))];
    // Prioritize API-looking URLs first (heuristic), then others
    urlsToTest.sort((a, b) => {
      const apiRe = /\/api\/|\/v[0-9]+\/|graphql|\/graphql/;
      const aIsApi = apiRe.test(a) ? 0 : 1;
      const bIsApi = apiRe.test(b) ? 0 : 1;
      if (aIsApi !== bIsApi) return aIsApi - bIsApi;
      return a.length - b.length; // shorter first
    });
    // Apply configured limit and hard cap of 50
    const configuredMax = parseInt(settings.maxInspectorEndpoints || DEFAULT_SETTINGS.maxInspectorEndpoints, 10) || DEFAULT_SETTINGS.maxInspectorEndpoints;
    const hardCap = 50;
    const maxToCheck = Math.min(urlsToTest.length, configuredMax, hardCap);
    if (maxToCheck === 0) {
      elements.inspector.resultList.innerHTML = 'No candidate endpoints to inspect (either none found or all are already monitored).';
      elements.inspector.startBtn.disabled = false;
      return;
    }

    let foundLinks = [];
    for (let i = 0; i < maxToCheck; i++) {
      const url = urlsToTest[i];
      elements.inspector.resultList.innerHTML = `<i>Inspecting (${i+1}/${maxToCheck}): ${escapeHtml(url)}</i>`;
      try {
        // quick ping using favicon (fast, lightweight)
        await pingFavicon(url, 3000);
        foundLinks.push(url);
      } catch (e) {
        // Some endpoints (APIs) may not serve favicon;
        // attempt a lightweight HEAD fetch if CORS allows
        try {
          const headResp = await fetch(url, { method: 'HEAD', mode: 'cors' });
          if (headResp && (headResp.ok || headResp.status < 400)) {
            foundLinks.push(url);
          }
        } catch (e2) {
          // ignore
        }
      }
    }

    // Render results
    if (foundLinks.length === 0) {
      elements.inspector.resultList.innerHTML = 'No new, live endpoints were found for that domain.';
    } else {
      // Limit UI list to hardCap too
      const displayList = foundLinks.slice(0, hardCap);
      elements.inspector.resultList.innerHTML = displayList.map(link => `
        <div class="result-row" data-link="${escapeHtml(link)}">
          <span>${escapeHtml(link)}</span>
          <button class="btn btn-green" onclick="addInspectedURL(this, '${escapeHtml(link)}')">Add</button>
        </div>
      `).join('');
      if (foundLinks.length > displayList.length) {
        elements.inspector.resultList.innerHTML += `<div class="small" style="margin-top:8px;">Results truncated to ${hardCap} entries.</div>`;
      }
    }

    elements.inspector.startBtn.disabled = false;
  }

  function addInspectedURL(button, url) {
    if (addURL(url, true)) {
        button.textContent = 'Added!';
        button.disabled = true;
        button.classList.remove('btn-green');
    } else {
        button.textContent = 'Exists';
        button.disabled = true;
        button.classList.remove('btn-green');
    }
  }

  // =============== Initialization ===============
  function initializeApp() {
    // Load data only after successful authentication
    settings = { ...DEFAULT_SETTINGS, ...loadFromStorage('ump_settings', {}) };
    urls = loadFromStorage('ump_urls', []);
    alerts = loadFromStorage('ump_alerts', []);

    // Add event listener for login form submission on Enter key
    elements.login.password.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') handleLogin();
    });
    urls.forEach(u => u.history = prune(u.history, 't'));
    render();
    updateAlertBadge();
    startChecking();
  }
</script>
</body>
</html>
