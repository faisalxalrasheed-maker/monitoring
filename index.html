<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>URL Monitor Pro (Secure)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --primary: #2196F3; --success: #2e7d32; --danger: #d32f2f; --warn: #f9a825; --muted: #666; --bg: #e3f2fd; --panel: #fff; --chip: #f5f5f5; --border: #eee; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: var(--bg); color: #333; margin: 0; }
    .wrap { max-width: 1100px; margin: 0 auto; background: var(--panel); padding: 20px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
    h1 { text-align: center; color: var(--primary); margin: 0 0 10px; }
    .actions { text-align: center; margin: 18px 0 24px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button { cursor: pointer; }
    .btn { padding: 12px 16px; border: none; font-size: 14px; border-radius: 6px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-green { background: #2e7d32; color: #fff; }
    .btn-purple { background: #6a1b9a; color: #fff; }
    .btn-red { background: #d32f2f; color: #fff; }
    .btn-gray { background: #9e9e9e; color: #fff; }
    .btn-orange { background: #f57c00; color: #fff; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 10px 0 20px; }
    .stat { background: var(--chip); padding: 14px; border-radius: 10px; text-align: center; }
    .stat .label { color: var(--muted); }
    .stat .value { font-size: 24px; font-weight: bold; }
    .grid { display: grid; gap: 12px; }
    .row { display:flex; align-items:center; gap:12px; padding:12px; border:1px solid var(--border); border-radius:10px; position:relative; }
    .row.paused-url { background: #fafafa; opacity: 0.7; }
    .row.maintenance-url { background: #fff8e1; }
    .dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
    .url { font-weight:600; word-break: break-all; }
    .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .timeline { width: 240px; height: 28px; }
    .chip { background:#eef7ff; color:#1976d2; border:1px solid #cfe8ff; padding:3px 6px; border-radius:999px; font-size:11px; font-weight:600; }
    .chip-warning { background:#fff3e0; color:#f57c00; border:1px solid #ffe0b2; }
    .chip-danger { background:#ffebee; color:#d32f2f; border:1px solid #ffcdd2; }
    .chip-success { background:#e8f5e8; color:#2e7d32; border:1px solid #c8e6c9; }
    .section { background:#f9f9f9; padding: 16px; border-radius: 10px; margin-top:20px; }
    .small { font-size: 12px; color: var(--muted); }
    .danger { color: var(--danger); }
    .success { color: var(--success); }
    .warn { color: var(--warn); }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 100; }
    .modal { background:#fff; width: 640px; max-width: 92vw; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; max-height: 85vh; }
    .modal header { padding:12px 16px; border-bottom:1px solid var(--border); font-weight:700; flex-shrink: 0; }
    .modal .body { padding:14px 16px; overflow-y: auto; }
    .modal .rowx { display:grid; grid-template-columns: 100px 1fr; gap:10px; align-items:center; margin-bottom: 12px; }
    .modal .rowx:last-child { margin-bottom: 0; }
    .modal .rowx input, .modal .rowx select, .modal .rowx textarea { width: 100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing: border-box; }
    .modal footer { display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--border); flex-shrink: 0; }
    #inspectorModal .body label { display: block; padding: 8px; border-radius: 6px; cursor: pointer; }
    #inspectorModal .body label:hover { background: #f0f0f0; }
    #inspectorModal .body input[type="radio"] { margin-right: 8px; }
    #inspectorResults .result-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; font-size: 14px; }
    #inspectorResults .result-row .btn { padding: 4px 10px; font-size: 12px; }
    #appContainer { display: none; }
    #loginModal { display: flex; }
    .tab-container { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
    .tab { padding: 10px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: var(--primary); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .alert-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
    .btn-with-badge { position: relative; }
    .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center; gap: 10px; max-width: 400px; }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.warning { border-left: 4px solid var(--warn); }
    .notification.error { border-left: 4px solid var(--danger); }
    .notification-close { background: none; border: none; font-size: 16px; cursor: pointer; margin-left: auto; }
    .url-actions { display: flex; gap: 5px; }
    .url-actions button { padding: 4px 8px; font-size: 12px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; gap: 5px; align-items: center; }
    .filter-select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; background: white; }
    .search-box { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 200px; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 5px; background: #e3f2fd; color: #1976d2; }
    .tag-group { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
    .details-panel { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 10px; }
    .details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .detail-item { margin-bottom: 8px; }
    .detail-label { font-weight: 600; color: var(--muted); font-size: 12px; }
    .detail-value { font-size: 14px; }
    .batch-actions { display: flex; gap: 10px; margin-bottom: 15px; }
    .url-checkbox { margin-right: 8px; }
    .collapsible { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
    .collapsible-header { padding: 12px 15px; background: #f5f5f5; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .collapsible-content { padding: 15px; display: none; }
    .dark-mode { --bg: #1e1e1e; --panel: #2d2d2d; --chip: #3d3d3d; --border: #444; color: #f0f0f0; }
    .theme-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .sparkline { width: 100px; height: 20px; }
    .url-group-header { padding: 10px; background: var(--chip); font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 15px; }
    .compact-view .sub, .compact-view .tag-group, .compact-view .timeline { display: none; }
    .compact-view .row { padding: 8px 12px; }
    @media (max-width: 600px) { 
      .row { flex-wrap: wrap; } 
      .right { width: 100%; justify-content: flex-end; } 
      .timeline, .sparkline { display:none; } 
      .filters { flex-direction: column; align-items: stretch;}
      .search-box { width: auto; }
    }
  </style>
</head>
<body>

<div id="loginModal" class="modal-backdrop">
    <div class="modal" style="width: 400px;">
      <header>Login to URL Monitor</header>
      <div class="body">
        <div class="rowx"><label for="username">Username</label><input id="username" type="text" /></div>
        <div class="rowx"><label for="password">Password</label><input id="password" type="password" /></div>
        <p id="loginError" class="danger" style="text-align:center; margin:0; display:none;"></p>
      </div>
      <footer>
        <button class="btn btn-primary" style="width:100%;" onclick="handleLogin()">Login</button>
      </footer>
    </div>
</div>

<div id="appContainer">
    <div class="wrap">
    <h1>üöÄ URL Monitor Pro</h1>

    <div class="actions">
        <button class="btn btn-green" onclick="showAddURLModal()">+ Add URL</button>
        <button class="btn btn-primary" onclick="showSettings()">‚öôÔ∏è Settings</button>
        <button class="btn btn-purple" onclick="showInspector()">üîé Auto Inspector</button>
        <button class="btn btn-orange btn-with-badge" onclick="showAlerts()">üîî Incidents<div id="alertBadge" class="alert-badge" style="display:none;">0</div></button>
        <button class="btn btn-gray" onclick="checkAll()">‚ñ∂Ô∏è Check All Now</button>
        <button class="btn btn-red" onclick="handleLogout()">üîí Logout</button>
    </div>

    <div class="stats">
        <div class="stat"><div class="label">Total</div><div class="value" id="total">0</div></div>
        <div class="stat"><div class="label">Healthy</div><div class="value success" id="online">0</div></div>
        <div class="stat"><div class="label">Issues</div><div class="value danger" id="offline">0</div></div>
        <div class="stat"><div class="label">SSL Issues</div><div class="value warn" id="sslIssues">0</div></div>
        <div class="stat"><div class="label">24h Uptime</div><div class="value" id="uptime24">0%</div></div>
        <div class="stat"><div class="label">Health Score</div><div class="value" id="healthScore">0%</div></div>
    </div>

    <div class="tab-container">
      <div class="tab active" data-tab="monitoring" onclick="switchTab('monitoring')">Monitoring</div>
      <div class="tab" data-tab="incidents" onclick="switchTab('incidents')">Incident History</div>
      <div class="tab" data-tab="statuspage" onclick="switchTab('statuspage')">Status Page</div>
      <div class="tab" data-tab="reports" onclick="switchTab('reports')">Reports</div>
    </div>

    <div id="monitoringTab" class="tab-content active">
      <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <h3 style="margin:0;">Monitored URLs</h3>
              <div class="small">History retained for last 24 hours</div>
          </div>
          
          <div class="filters">
            <input type="text" id="searchUrls" class="search-box" placeholder="Search URLs..." onkeyup="filterURLs()">
            <div class="filter-group">
              <label>Status:</label>
              <select id="statusFilter" class="filter-select" onchange="filterURLs()">
                <option value="all">All</option>
                <option value="online">Healthy</option>
                <option value="offline">Issues</option>
                <option value="paused">Paused</option>
              </select>
            </div>
             <div class="filter-group">
              <label>Sort:</label>
              <select id="sortFilter" class="filter-select" onchange="sortURLs()">
                <option value="default">Default</option>
                <option value="url-asc">URL (A-Z)</option>
                <option value="status-desc">Status</option>
                <option value="rt-desc">Response Time</option>
              </select>
            </div>
            <div class="filter-group" style="margin-left: auto;">
              <label><input type="checkbox" id="compactViewToggle" onchange="toggleCompactView(this.checked)"> Compact View</label>
            </div>
          </div>
          
          <div class="batch-actions">
            <button class="btn btn-gray" onclick="selectAllURLs()">Select All</button>
            <button class="btn btn-gray" onclick="deselectAllURLs()">Deselect All</button>
            <button class="btn btn-primary" onclick="checkSelectedURLs()">Check Selected</button>
            <button class="btn btn-orange" onclick="pauseSelectedURLs()">Pause Selected</button>
            <button class="btn btn-green" onclick="resumeSelectedURLs()">Resume Selected</button>
            <button class="btn btn-red" onclick="deleteSelectedURLs()">Delete Selected</button>
          </div>
          
          <div id="urlList" class="grid">No URLs added yet</div>
      </div>
    </div>

    <div id="incidentsTab" class="tab-content">
      <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <h3 style="margin:0;">Incident History</h3>
              <button class="btn btn-gray" onclick="clearAlerts()">Clear All</button>
          </div>
          <div id="alertList" class="grid">No incidents yet</div>
      </div>
    </div>

    <div id="statuspageTab" class="tab-content">
       <div class="section">
            <h3 style="margin:0 0 15px;">Public Status Page Generator</h3>
            <p class="small">Generate a standalone HTML file to share the status of your services. The generated file does not require this tool to be viewed.</p>
            <button class="btn btn-primary" onclick="generateStatusPage()">Generate & Download Status Page</button>
       </div>
    </div>

    <div id="reportsTab" class="tab-content">
       <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <h3 style="margin:0;">Monitoring Reports</h3>
              <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
          </div>
          <div id="reportsContainer">
            <div class="details-panel">
              <h4>System Health Overview</h4>
              </div>
          </div>
      </div>
    </div>

    </div>
</div>

<div id="addUrlModal" class="modal-backdrop">
  <div class="modal" role="dialog">
    <header id="addUrlModalTitle">Add New URL</header>
    <div class="body">
      <input type="hidden" id="editUrlOriginal">
      <div class="rowx" style="grid-template-columns: 140px 1fr;"><label>URL</label><input id="addUrlInput" type="text" placeholder="https://example.com" /></div>
      <div class="rowx" style="grid-template-columns: 140px 1fr;"><label>Group</label><input id="addUrlGroup" type="text" placeholder="e.g., Production APIs" /></div>
      <div class="rowx" style="grid-template-columns: 140px 1fr;"><label>Notes</label><textarea id="addUrlNotes" rows="2" placeholder="Optional notes about this endpoint"></textarea></div>
      <div class="section" style="padding-top:0;">
        <h4>Advanced Options</h4>
        <div class="rowx" style="grid-template-columns: 140px 1fr;"><label>Check Interval (sec)</label><input id="addUrlInterval" type="number" min="10" placeholder="Global default" /></div>
        <div class="rowx" style="grid-template-columns: 140px 1fr;"><label>Expected Status Code</label><input id="addUrlStatusCode" type="number" min="100" max="599" placeholder="e.g., 200" /></div>
        <div class="rowx" style="grid-template-columns: 140px 1fr;"><label>Content Keyword</label><input id="addUrlKeyword" type="text" placeholder="Text to find on page" /></div>
        <div class="rowx" style="grid-template-columns: 140px 1fr;"><label>Custom Headers (JSON)</label><textarea id="addUrlHeaders" rows="3" placeholder='{ "Authorization": "Bearer ..." }'></textarea></div>
      </div>
    </div>
    <footer>
      <button class="btn btn-gray" onclick="document.getElementById('addUrlModal').style.display='none'">Cancel</button>
      <button class="btn btn-primary" onclick="saveURL()">Save URL</button>
    </footer>
  </div>
</div>


<div id="settingsModal" class="modal-backdrop" onclick="this.style.display='none'">
  <div class="modal" role="dialog" onclick="event.stopPropagation()" style="width: 800px;">
    <header>Settings</header>
    <div class="body" style="display:flex; gap: 20px;">
      <div style="flex:1;">
        <h4>Monitoring</h4>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Check Interval (sec)</label><input id="interval" type="number" min="10" /></div>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Request Timeout (ms)</label><input id="timeout" type="number" min="1000" /></div>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Retry Failed Checks</label><select id="retryFailed"><option value="0">No Retry</option><option value="1">1 Retry</option><option value="2">2 Retries</option></select></div>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>SSL Expiry Warning (days)</label><input id="sslWarningDays" type="number" min="1" /></div>
        <hr>
        <h4>Notifications & Sync <span class="small">(Backend Required)</span></h4>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Notification Email</label><input id="notificationEmail" type="email" placeholder="you@example.com" /></div>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Webhook URL</label><input id="webhookUrl" type="text" placeholder="https://hooks.slack.com/..." /></div>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Profile Name</label><input id="profileName" type="text" placeholder="e.g., personal-profile" /></div>
        <div class="rowx" style="grid-template-columns: 170px 1fr;"><label>Profile Sync API Key</label><input id="profileApiKey" type="password" /></div>
        <button class="btn btn-primary" onclick="syncProfile()">Sync Manually</button>
      </div>
      <div style="flex:1; border-left: 1px solid var(--border); padding-left: 20px;">
        <h4>Data Management</h4>
        <p class="small">Import or export your list of monitored URLs.</p>
        <button class="btn btn-gray" onclick="document.getElementById('importFile').click()">Import URLs from TXT</button>
        <input type="file" id="importFile" accept=".txt" style="display:none" onchange="importURLs(this.files[0])">
        <button class="btn btn-gray" onclick="exportURLs()">Export URLs to TXT</button>
        <hr>
        <p class="small danger">These actions cannot be undone.</p>
        <button class="btn btn-orange" onclick="clearHistory()">Clear All History</button>
        <button class="btn btn-red" onclick="factoryReset()">Factory Reset</button>
      </div>
    </div>
    <footer>
      <button class="btn btn-gray" onclick="document.getElementById('settingsModal').style.display='none'">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </footer>
  </div>
</div>

<div id="inspectorModal" class="modal-backdrop">...</div>
<div id="urlDetailsModal" class="modal-backdrop">...</div>

<button class="theme-toggle" onclick="toggleDarkMode()">üåô</button>

<script>
  // =============== State & Persistence ===============
  const DEFAULT_SETTINGS = {
    intervalSec: 60,
    timeoutMs: 8000,
    sslWarningDays: 30,
    retryFailed: 1,
    darkMode: false,
    notificationEmail: '',
    webhookUrl: '',
    profileName: '',
    profileApiKey: ''
  };
  
  const DEFAULT_UI_STATE = {
      activeTab: 'monitoring',
      sortKey: 'default',
      compactView: false,
      collapsedGroups: []
  };

  const $ = (selector) => document.querySelector(selector);

  const elements = {
      appContainer: $('#appContainer'),
      login: { modal: $('#loginModal'), username: $('#username'), password: $('#password'), error: $('#loginError') },
      modals: { 
        settings: $('#settingsModal'), 
        inspector: $('#inspectorModal'), 
        urlDetails: $('#urlDetailsModal'),
        addUrl: $('#addUrlModal')
      },
      urlList: $('#urlList'),
      alertList: $('#alertList'),
      stats: { total: $('#total'), online: $('#online'), offline: $('#offline'), sslIssues: $('#sslIssues'), uptime24: $('#uptime24'), healthScore: $('#healthScore') },
      inputs: { 
        interval: $('#interval'), timeout: $('#timeout'), sslWarningDays: $('#sslWarningDays'), retryFailed: $('#retryFailed'),
        notificationEmail: $('#notificationEmail'), webhookUrl: $('#webhookUrl'), profileName: $('#profileName'), profileApiKey: $('#profileApiKey')
      },
      alertBadge: $('#alertBadge'),
      searchUrls: $('#searchUrls'),
      statusFilter: $('#statusFilter'),
      sortFilter: $('#sortFilter'),
      compactViewToggle: $('#compactViewToggle')
  };

  let timer = null;
  let settings, urls, alerts, uiState;
  let selectedURLs = new Set();
  
  const loadFromStorage = (key, fallback) => { try { return JSON.parse(localStorage.getItem(key)) || fallback; } catch { return fallback; } };
  const persist = (key, data) => localStorage.setItem(key, JSON.stringify(data));
  const persistUrls = () => persist('ump_urls', urls);
  const persistSettings = () => persist('ump_settings', settings);
  const persistAlerts = () => persist('ump_alerts', alerts);
  const persistUiState = () => persist('ump_uiState', uiState);

  // =============== Authentication ===============
  const CREDENTIALS = { user: 'Faisal', pass: '456456f' };
  // ... (handleLogin, handleLogout, auto-login logic from original code) ...

  // =============== Utilities ===============
  // ... (normalizeUrl, escapeHtml, average, now, DAY_MS, prune from original code) ...
  const formatDuration = (ms) => {
      if (ms < 1000) return `${ms} ms`;
      const seconds = Math.floor(ms / 1000);
      if (seconds < 60) return `${seconds}s`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ${minutes % 60}m`;
  };

  const addHistory = (item, status, rt, statusCode, message) => {
    item.history = prune(item.history, 't');
    item.history.push({ t: now(), status, rt: typeof rt === 'number' ? rt : null, sc: statusCode, msg: message });
  };
  
  // =============== Checkers ===============
  // MODIFIED checkUrl to be much more advanced
  async function checkUrl(item, retryCount = 0) {
    if (item.paused) return;
    
    const start = performance.now();
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), item.overrideInterval ? item.timeout : settings.timeoutMs);
    
    try {
        const headers = item.headers ? JSON.parse(item.headers) : {};
        const response = await fetch(item.url, {
            method: 'GET',
            mode: 'cors', // This may still be restricted by browser policy
            signal: controller.signal,
            headers: headers,
            redirect: 'follow'
        });
        clearTimeout(timeoutId);
        const rt = performance.now() - start;

        let status = 'online';
        let message = `Responded with status ${response.status}`;

        // 1. Status Code Check
        if (item.expectedStatusCode && response.status !== item.expectedStatusCode) {
            status = 'offline';
            message = `Expected status ${item.expectedStatusCode}, but got ${response.status}`;
        }

        // 2. Keyword Check
        if (status === 'online' && item.keyword) {
            const body = await response.text();
            if (!body.includes(item.keyword)) {
                status = 'offline';
                message = `Keyword "${item.keyword}" not found on page.`;
            }
        }
        
        const lastStatus = item.history.slice(-1)[0]?.status;
        if (status === 'offline' && lastStatus !== 'offline') {
            addAlert(item.url, 'Endpoint Down', message, 'error', now());
        } else if (status === 'online' && lastStatus === 'offline') {
            addAlert(item.url, 'Endpoint Recovered', `Endpoint is back online.`, 'success');
        }

        addHistory(item, status, rt, response.status, message);
        item.lastCheck = now();

    } catch (error) {
        clearTimeout(timeoutId);
        const rt = performance.now() - start;

        // Retry logic
        const maxRetries = item.overrideRetry ?? settings.retryFailed;
        if (retryCount < maxRetries) {
            console.log(`Retrying ${item.url} (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => checkUrl(item, retryCount + 1), 3000);
            return;
        }

        const message = error.name === 'AbortError' ? 'Request timed out' : error.message;
        const lastStatus = item.history.slice(-1)[0]?.status;
        if (lastStatus !== 'offline') {
            addAlert(item.url, 'Connection Error', message, 'error', now());
        }
        addHistory(item, 'offline', rt, null, message);
    }
    
    // SSL Check (runs less frequently)
    const lastSSLCheck = item.lastSSLCheck || 0;
    if (now() - lastSSLCheck > DAY_MS) {
        const sslResult = await checkSSLCertificate(item.url);
        item.sslInfo = sslResult;
        item.lastSSLCheck = now();
        if (sslResult.daysRemaining <= settings.sslWarningDays) {
          addAlert(item.url, 'SSL Expiry Warning', `SSL for ${item.url} expires in ${sslResult.daysRemaining} days.`, 'warning');
        }
    }
  }
  
  // ... (checkSSLCertificate from original code) ...

  async function checkAll() { /* ... unchanged ... */ }
  const startChecking = () => { /* ... unchanged ... */ };
  const stopChecking = () => { /* ... unchanged ... */ };
  
  // =============== Alert / Incident System ===============
  function addAlert(url, title, message, type = 'info', incidentStart = null) {
      // Group alerts into incidents
      const lastAlert = alerts.find(a => a.url === url && a.resolved === false);

      if (type === 'error' && !lastAlert) {
          // New incident
          const incident = {
              id: now() + Math.random(),
              startTime: incidentStart || now(),
              url, title, message, type,
              read: false, resolved: false, endTime: null
          };
          alerts.unshift(incident);
      } else if (type === 'success' && lastAlert) {
          // Resolve existing incident
          lastAlert.resolved = true;
          lastAlert.endTime = now();
          showNotification({ title: `Resolved: ${lastAlert.url}`, message: `Downtime: ${formatDuration(lastAlert.endTime - lastAlert.startTime)}`, type: 'success' });
      } else if (type === 'warning') {
           // Standalone warning (like SSL)
           alerts.unshift({ id: now() + Math.random(), startTime: now(), url, title, message, type, read: true, resolved: true, endTime: now() });
           showNotification({ title, message, type });
      }
      
      alerts = alerts.slice(0, 100);
      persistAlerts();
      updateAlertBadge();
      playAlertSound();
  }
  
  // =============== Backend Placeholder Functions ===============
  async function sendEmailNotification(subject, body) {
      console.log(`--- EMAIL NOTIFICATION (SIMULATED) ---
To: ${settings.notificationEmail}
Subject: ${subject}
Body: ${body}
-----------------------------------------`);
      // **BACKEND INTEGRATION POINT**
      // In a real application, you would make a fetch() call to your backend API here.
      // Your backend would then use a service like SendGrid, Mailgun, or AWS SES to send the email.
      // Example:
      // await fetch('https://api.yourserver.com/send-email', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify({ to: settings.notificationEmail, subject, body })
      // });
  }

  async function sendWebhookNotification(payload) {
    console.log(`--- WEBHOOK NOTIFICATION (SIMULATED) ---
URL: ${settings.webhookUrl}
Payload: ${JSON.stringify(payload, null, 2)}
------------------------------------------`);
    // **BACKEND INTEGRATION POINT**
    // It's better to send webhooks from a backend to hide the URL and handle retries.
    // Your client would call your API, which then dispatches the webhook.
    // Example:
    // await fetch('https://api.yourserver.com/send-webhook', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({ webhookUrl: settings.webhookUrl, payload })
    // });
  }

  async function syncProfile() {
      if (!settings.profileName || !settings.profileApiKey) {
          alert('Please set a Profile Name and API Key in Settings to use sync.');
          return;
      }
      console.log(`--- PROFILE SYNC (SIMULATED) ---
Action: Uploading current state to profile '${settings.profileName}'
--------------------------------------`);
      // **BACKEND INTEGRATION POINT**
      // This function would collect all local data and send it to your backend.
      // A corresponding `loadProfile()` function would fetch it.
      // Services like Firebase Realtime Database or Supabase are great for this.
      // Example:
      // const dataToSync = { urls, settings, alerts, uiState };
      // await fetch(`https://api.yourdatabase.com/profiles/${settings.profileName}`, {
      //   method: 'PUT',
      //   headers: { 'Authorization': `Bearer ${settings.profileApiKey}` },
      //   body: JSON.stringify(dataToSync)
      // });
      showNotification({title: "Profile Sync", message: "Data sync initiated (simulated).", type: "success"});
  }

  // =============== New Features & Actions ===============
  // ... (All new feature functions like sortURLs, toggleCompactView, pause/resume, import/export, etc.) ...
  function sortURLs() {
      uiState.sortKey = elements.sortFilter.value;
      const key = uiState.sortKey;
      
      urls.sort((a, b) => {
          const lastA = a.history.slice(-1)[0] || {};
          const lastB = b.history.slice(-1)[0] || {};
          switch(key) {
              case 'url-asc': return a.url.localeCompare(b.url);
              case 'status-desc': return (lastA.status === 'online' ? 1 : -1) - (lastB.status === 'online' ? 1 : -1);
              case 'rt-desc': return (lastB.rt || -1) - (lastA.rt || -1);
              default: return 0; // Keep original order
          }
      });
      render();
      persistUiState();
  }

  function toggleCompactView(isCompact) {
      uiState.compactView = isCompact;
      $('#urlList').classList.toggle('compact-view', isCompact);
      persistUiState();
  }
  
  // ... (Many more new functions) ...

  // =============== UI / Rendering ===============
  // MODIFIED renderUrlRow to include all new UI elements
  const renderUrlRow = (item) => {
    const last = item.history?.slice(-1)[0] ?? {};
    const statusClass = last.status === 'online' ? 'success' : last.status === 'offline' ? 'danger' : 'muted';
    const rtText = typeof last.rt === 'number' ? `${Math.round(last.rt)}ms` : '‚Äî';
    const downtime24h = calculateDowntime(item.history, 24);
    
    // Sparkline data
    const sparklinePoints = (item.history || []).slice(-24).map((h, i) => `${i * 4},${20 - Math.min(20, (h.rt || 0) / 100)}`).join(' ');

    let maintenanceHtml = '';
    // ... logic to show maintenance mode icon if active

    return `
      <div class="row ${item.paused ? 'paused-url' : ''}" data-url="${escapeHtml(item.url)}">
        <input type="checkbox" class="url-checkbox" ${selectedURLs.has(item.url) ? 'checked' : ''} onchange="toggleURLSelection('${escapeHtml(item.url)}', this.checked)">
        <div class="dot" style="background:var(--${statusClass})"></div>
        <div style="flex: 1;">
          <div class="url">${escapeHtml(item.url)}</div>
          <div class="sub">Status: <b class="${statusClass}">${last.status || 'pending'}</b> | ${last.sc ? `Code: ${last.sc}` : ''} | Last check: ${last.t ? new Date(last.t).toLocaleTimeString() : 'N/A'}</div>
          <div class="sub">24h Downtime: ${formatDuration(downtime24h)}</div>
          ${item.tags ? `<div class="tag-group">${item.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : ''}
        </div>
        <div class="right">
          <svg class="sparkline" viewBox="0 0 96 20"><polyline points="${sparklinePoints}" fill="none" stroke="var(--primary)" stroke-width="1"/></svg>
          <div class="chip">${rtText}</div>
          <div class="url-actions">
            <button onclick="togglePauseURL('${escapeHtml(item.url)}')">${item.paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'}</button>
            <button onclick="showEditURLModal('${escapeHtml(item.url)}')">‚úèÔ∏è</button>
            <button onclick="deleteURL('${escapeHtml(item.url)}')">üóëÔ∏è</button>
          </div>
        </div>
      </div>`;
  };

  const render = () => {
    // Apply sorting first
    sortURLs();
    
    // Apply filtering
    const filteredUrls = filterURLs(); 
    renderURLList(filteredUrls); 
    
    renderStats();
  };

  // =============== Initialization ===============
  function initializeApp() {
    settings = { ...DEFAULT_SETTINGS, ...loadFromStorage('ump_settings', {}) };
    urls = loadFromStorage('ump_urls', []);
    alerts = loadFromStorage('ump_alerts', []);
    uiState = { ...DEFAULT_UI_STATE, ...loadFromStorage('ump_uiState', {}) };

    // Apply persistent UI state
    elements.sortFilter.value = uiState.sortKey;
    elements.compactViewToggle.checked = uiState.compactView;
    switchTab(uiState.activeTab);
    
    // ... (rest of init from original code) ...
    
    // Add Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'A') {
            e.preventDefault();
            showAddURLModal();
        }
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            elements.searchUrls.focus();
        }
    });

    render();
    updateAlertBadge();
    startChecking();
  }
  
  // Auto-login if session is active
  if (sessionStorage.getItem('isAuthenticated') === 'true') {
    elements.login.modal.style.display = 'none';
    elements.appContainer.style.display = 'block';
    initializeApp();
  }

</script>
</body>
</html>
