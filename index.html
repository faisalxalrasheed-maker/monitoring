<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Monitor Pro (Enhanced)</title>
    <style>
        :root {
            --primary: #2196F3;
            --success: #2e7d32;
            --danger: #d32f2f;
            --warn: #f9a825;
            --muted: #666;
            --bg: #e3f2fd;
            --panel: #fff;
            --chip: #f5f5f5;
            --border: #eee;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            background: var(--bg);
            color: #333;
            margin: 0;
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--panel);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.06);
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin: 0 0 10px;
        }

        .actions {
            text-align: center;
            margin: 18px 0 24px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 16px;
            border: none;
            font-size: 14px;
            border-radius: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-green {
            background: #2e7d32;
            color: #fff;
        }

        .btn-purple {
            background: #6a1b9a;
            color: #fff;
        }

        .btn-red {
            background: #d32f2f;
            color: #fff;
        }

        .btn-gray {
            background: #9e9e9e;
            color: #fff;
        }

        .btn-orange {
            background: #f57c00;
            color: #fff;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 10px 0 20px;
        }

        .stat {
            background: var(--chip);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
        }

        .stat .label {
            color: var(--muted);
            font-size: 14px;
        }

        .stat .value {
            font-size: 24px;
            font-weight: bold;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .row:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .url {
            font-weight: 600;
            word-break: break-all;
        }

        .sub {
            color: var(--muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .right {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .timeline {
            width: 240px;
            height: 28px;
        }

        .chip {
            background: #eef7ff;
            color: #1976d2;
            border: 1px solid #cfe8ff;
            padding: 3px 6px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .chip-warning {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffe0b2;
        }

        .chip-danger {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        .chip-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .section {
            background: #f9f9f9;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .small {
            font-size: 12px;
            color: var(--muted);
        }

        .danger {
            color: var(--danger);
        }

        .success {
            color: var(--success);
        }

        .warn {
            color: var(--warn);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal {
            background: #fff;
            width: 640px;
            max-width: 92vw;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        .modal header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            flex-shrink: 0;
            background: #f5f5f5;
        }

        .modal .body {
            padding: 14px 16px;
            overflow-y: auto;
        }

        .modal .rowx {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal .rowx:last-child {
            margin-bottom: 0;
        }

        .modal .rowx input, .modal .rowx select, .modal .rowx textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
        }

        .modal footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            background: #f5f5f5;
        }

        #inspectorModal .body label {
            display: block;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
        }

        #inspectorModal .body label:hover {
            background: #f0f0f0;
        }

        #inspectorModal .body input[type="radio"] {
            margin-right: 8px;
        }

        #inspectorResults .result-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }

        #inspectorResults .result-row .btn {
            padding: 4px 10px;
            font-size: 12px;
        }

        #appContainer {
            display: none;
        }

        #loginModal {
            display: flex;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            font-weight: 600;
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-with-badge {
            position: relative;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.warning {
            border-left: 4px solid var(--warn);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            margin-left: auto;
        }

        /* Enhanced Styles */
        .url-actions {
            display: flex;
            gap: 5px;
        }

        .url-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
        }

        .health-good {
            background: var(--success);
        }

        .health-warning {
            background: var(--warn);
        }

        .health-critical {
            background: var(--danger);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .filter-select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 200px;
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-right: 5px;
            background: #e3f2fd;
            color: #1976d2;
        }

        .tag-group {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
        }

        .progress-warning {
            background: var(--warn);
        }

        .progress-critical {
            background: var(--danger);
        }

        .chart-container {
            height: 200px;
            margin: 15px 0;
        }

        .details-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .detail-item {
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--muted);
            font-size: 12px;
        }

        .detail-value {
            font-size: 14px;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .url-checkbox {
            margin-right: 8px;
        }

        .collapsible {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 12px 15px;
            background: #f5f5f5;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-content {
            padding: 15px;
            display: none;
        }

        .response-time-chart {
            height: 80px;
            margin-top: 10px;
        }

        .trend-indicator {
            display: inline-block;
            margin-left: 5px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .export-option {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-option:hover {
            background: #f5f5f5;
        }

        .export-option.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }

        .dark-mode {
            --bg: #1e1e1e;
            --panel: #2d2d2d;
            --chip: #3d3d3d;
            --border: #444;
            color: #f0f0f0;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* New Feature Styles */
        .profile-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .profile-select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
        }

        .email-settings {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .email-settings h4 {
            margin-top: 0;
        }

        .incident-timeline {
            margin-top: 15px;
        }

        .incident-item {
            border-left: 3px solid var(--danger);
            padding-left: 15px;
            margin-bottom: 15px;
        }

        .incident-resolved {
            border-left-color: var(--success);
        }

        .location-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .performance-gauge {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .gauge-background, .gauge-fill {
            fill: none;
            stroke-width: 10;
        }

        .gauge-background {
            stroke: #e0e0e0;
        }

        .gauge-fill {
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s;
        }

        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .gauge-value {
            font-size: 24px;
            font-weight: bold;
        }

        .gauge-label {
            font-size: 12px;
            color: var(--muted);
        }

        .api-key {
            font-family: monospace;
            background: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .backup-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .backup-option {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .backup-option:hover {
            background: #f5f5f5;
        }

        .backup-option.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }

        .maintenance-window {
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .maintenance-active {
            background: #ffebee;
            border-color: #ffcdd2;
        }

        .custom-check-interval {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .custom-check-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .status-page-preview {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background: white;
        }

        .status-page-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-page-item:last-child {
            border-bottom: none;
        }

        .api-test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }

        .api-test-success {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
        }

        .api-test-error {
            background: #ffebee;
            border: 1px solid #ffcdd2;
        }

        .webhook-test {
            margin-top: 10px;
        }

        .location-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .location-option {
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .location-option:hover {
            background: #f5f5f5;
        }

        .location-option.selected {
            border-color: var(--primary);
            background: #e3f2fd;
        }

        .incident-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .schedule-item:last-child {
            border-bottom: none;
        }

        .api-docs {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .api-endpoint {
            font-family: monospace;
            background: #f1f1f1;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        .backup-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .backup-success {
            color: var(--success);
        }

        .backup-error {
            color: var(--danger);
        }

        .downtime-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 10px;
        }

        .calendar-day.downtime {
            background: var(--danger);
            color: white;
        }

        .calendar-day.partial {
            background: var(--warn);
            color: white;
        }

        .calendar-day.none {
            background: #f0f0f0;
        }

        .response-codes {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .response-code {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .code-2xx {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .code-3xx {
            background: #e3f2fd;
            color: #1976d2;
        }

        .code-4xx {
            background: #fff3e0;
            color: #f57c00;
        }

        .code-5xx {
            background: #ffebee;
            color: #d32f2f;
        }

        .custom-field {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .custom-field input {
            flex: 1;
        }

        .dependency-map {
            height: 300px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 15px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-action {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            flex: 1;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .quick-action:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .row {
                flex-wrap: wrap;
            }
            .right {
                width: 100%;
                justify-content: flex-end;
            }
            .timeline {
                display: none;
            }
            .filters {
                flex-direction: column;
            }
            .search-box {
                width: 100%;
            }
            .quick-actions {
                flex-direction: column;
            }
            .modal .rowx {
                grid-template-columns: 1fr;
            }
            .actions {
                flex-direction: column;
                align-items: center;
            }
            .actions button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginModal" class="modal-backdrop">
    <div class="modal" style="width: 400px;">
        <header>Login to URL Monitor</header>
        <div class="body">
            <div class="rowx"><label for="username">Username</label><input id="username" type="text" /></div>
            <div class="rowx"><label for="password">Password</label><input id="password" type="password" /></div>
            <p id="loginError" class="danger" style="text-align:center; margin:0; display:none;"></p>
        </div>
        <footer>
            <button class="btn btn-primary" style="width:100%;" onclick="handleLogin()">Login</button>
        </footer>
    </div>
</div>

<!-- Main Application -->
<div id="appContainer">
    <div class="wrap">
        <h1>🔍 URL Monitor Pro</h1>

        <!-- Profile Selector -->
        <div class="profile-selector">
            <label for="profileSelect">Profile:</label>
            <select id="profileSelect" class="profile-select" onchange="switchProfile(this.value)">
                <option value="default">Default Profile</option>
            </select>
            <button class="btn btn-gray" onclick="showProfileManager()">Manage Profiles</button>
            <button class="btn btn-primary" onclick="syncProfiles()">Sync Profiles</button>
        </div>

        <div class="actions">
            <button class="btn btn-green" onclick="showAddURLModal()">+ Add URL</button>
            <button class="btn btn-primary" onclick="showSettings()">⚙️ Settings</button>
            <button class="btn btn-purple" onclick="showInspector()">🔎 Auto Inspector</button>
            <button class="btn btn-orange btn-with-badge" onclick="showAlerts()">🔔 Alerts<div id="alertBadge" class="alert-badge" style="display:none;">0</div></button>
            <button class="btn btn-gray" onclick="checkAll()">▶️ Check All Now</button>
            <button class="btn btn-red" onclick="handleLogout()">🔒 Logout</button>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action" onclick="checkAll()">
                <div>🔄</div>
                <div>Check All</div>
            </div>
            <div class="quick-action" onclick="showAddURLModal()">
                <div>➕</div>
                <div>Add URL</div>
            </div>
            <div class="quick-action" onclick="exportData()">
                <div>📤</div>
                <div>Export</div>
            </div>
            <div class="quick-action" onclick="showReports()">
                <div>📊</div>
                <div>Reports</div>
            </div>
        </div>

        <div class="stats">
            <div class="stat"><div class="label">Total</div><div class="value" id="total">0</div></div>
            <div class="stat"><div class="label">Online</div><div class="value success" id="online">0</div></div>
            <div class="stat"><div class="label">Offline</div><div class="value danger" id="offline">0</div></div>
            <div class="stat"><div class="label">SSL Issues</div><div class="value warn" id="sslIssues">0</div></div>
            <div class="stat"><div class="label">24h Uptime</div><div class="value" id="uptime24">0%</div></div>
            <div class="stat"><div class="label">Avg RT (24h)</div><div class="value" id="avgRt24">—</div></div>
            <div class="stat"><div class="label">Health Score</div><div class="value" id="healthScore">0%</div></div>
        </div>

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('monitoring')">Monitoring</div>
            <div class="tab" onclick="switchTab('alerts')">Alert History</div>
            <div class="tab" onclick="switchTab('incidents')">Incidents</div>
            <div class="tab" onclick="switchTab('export')">Export Data</div>
            <div class="tab" onclick="switchTab('reports')">Reports</div>
            <div class="tab" onclick="switchTab('integrations')">Integrations</div>
            <div class="tab" onclick="switchTab('api')">API</div>
        </div>

        <div id="monitoringTab" class="tab-content active">
            <div class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 style="margin:0;">Monitored URLs</h3>
                    <div class="small">History retained for last 24 hours</div>
                </div>

                <div class="filters">
                    <input type="text" id="searchUrls" class="search-box" placeholder="Search URLs..." onkeyup="filterURLs()">
                    <div class="filter-group">
                        <label>Status:</label>
                        <select id="statusFilter" class="filter-select" onchange="filterURLs()">
                            <option value="all">All</option>
                            <option value="online">Online</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Tags:</label>
                        <select id="tagFilter" class="filter-select" onchange="filterURLs()">
                            <option value="all">All Tags</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>SSL:</label>
                        <select id="sslFilter" class="filter-select" onchange="filterURLs()">
                            <option value="all">All</option>
                            <option value="expiring">Expiring Soon</option>
                            <option value="valid">Valid</option>
                        </select>
                    </div>
                </div>

                <div class="batch-actions">
                    <button class="btn btn-gray" onclick="selectAllURLs()">Select All</button>
                    <button class="btn btn-gray" onclick="deselectAllURLs()">Deselect All</button>
                    <button class="btn btn-primary" onclick="checkSelectedURLs()">Check Selected</button>
                    <button class="btn btn-red" onclick="deleteSelectedURLs()">Delete Selected</button>
                </div>

                <div id="urlList" class="grid">No URLs added yet</div>
            </div>
        </div>

        <div id="alertsTab" class="tab-content">
            <div class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 style="margin:0;">Alert History</h3>
                    <button class="btn btn-gray" onclick="clearAlerts()">Clear All</button>
                </div>
                <div id="alertList" class="grid">No alerts yet</div>
            </div>
        </div>

        <div id="incidentsTab" class="tab-content">
            <div class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 style="margin:0;">Incident Management</h3>
                    <button class="btn btn-primary" onclick="createIncident()">+ New Incident</button>
                </div>
                <div id="incidentList" class="grid">No incidents recorded</div>
            </div>
        </div>

        <div id="exportTab" class="tab-content">
            <div class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 style="margin:0;">Export Monitoring Data</h3>
                </div>
                <div class="export-options">
                    <div class="export-option selected" onclick="selectExportOption(this, 'csv')">
                        <div><strong>CSV Format</strong></div>
                        <div class="small">Export as comma-separated values</div>
                    </div>
                    <div class="export-option" onclick="selectExportOption(this, 'json')">
                        <div><strong>JSON Format</strong></div>
                        <div class="small">Export as structured JSON data</div>
                    </div>
                    <div class="export-option" onclick="selectExportOption(this, 'pdf')">
                        <div><strong>PDF Report</strong></div>
                        <div class="small">Generate a PDF summary report</div>
                    </div>
                    <div class="export-option" onclick="selectExportOption(this, 'html')">
                        <div><strong>HTML Dashboard</strong></div>
                        <div class="small">Export as standalone HTML dashboard</div>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label><input type="checkbox" id="includeHistory" checked> Include historical data</label>
                    <label style="margin-left: 16px;"><input type="checkbox" id="includeSSL" checked> Include SSL information</label>
                </div>
                <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                <div id="exportResult" style="margin-top: 16px;"></div>

                <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <h4>Backup & Restore</h4>
                    <div class="backup-options">
                        <div class="backup-option selected" onclick="selectBackupOption(this, 'local')">
                            <div><strong>Local Backup</strong></div>
                            <div class="small">Save to your device</div>
                        </div>
                        <div class="backup-option" onclick="selectBackupOption(this, 'cloud')">
                            <div><strong>Cloud Backup</strong></div>
                            <div class="small">Save to cloud storage</div>
                        </div>
                        <div class="backup-option" onclick="selectBackupOption(this, 'scheduled')">
                            <div><strong>Scheduled Backup</strong></div>
                            <div class="small">Automatic backups</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="createBackup()">Create Backup</button>
                        <button class="btn btn-gray" onclick="restoreBackup()">Restore Backup</button>
                    </div>
                    <div id="backupStatus" class="backup-status"></div>
                </div>
            </div>
        </div>

        <div id="reportsTab" class="tab-content">
            <div class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 style="margin:0;">Monitoring Reports</h3>
                    <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                </div>
                <div id="reportsContainer">
                    <div class="details-panel">
                        <h4>System Health Overview</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Overall Health Score</div>
                                <div class="detail-value">
                                    <span class="health-indicator" id="overallHealthIndicator"></span>
                                    <span id="overallHealthScore">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="healthProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Uptime (7 days)</div>
                                <div class="detail-value" id="uptime7Days">0%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Avg Response Time</div>
                                <div class="detail-value" id="avgResponseTime">—</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Checks (24h)</div>
                                <div class="detail-value" id="totalChecks24h">0</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>Performance Trends</h4>
                        <div class="chart-container" id="performanceChart">
                            <div style="text-align: center; padding: 40px 0; color: var(--muted);">
                                Performance chart will appear here when data is available
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>Endpoint Health Details</h4>
                        <div id="endpointHealthList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="integrationsTab" class="tab-content">
            <div class="section">
                <h3 style="margin:0 0 15px 0;">Integrations</h3>

                <div class="email-settings">
                    <h4>Email Notifications</h4>
                    <div class="rowx">
                        <label for="emailEnabled">Enable Email Alerts</label>
                        <input type="checkbox" id="emailEnabled" onchange="toggleEmailSettings()">
                    </div>
                    <div id="emailSettings" style="display: none;">
                        <div class="rowx"><label for="smtpServer">SMTP Server</label><input id="smtpServer" type="text" placeholder="smtp.example.com"></div>
                        <div class="rowx"><label for="smtpPort">SMTP Port</label><input id="smtpPort" type="number" value="587"></div>
                        <div class="rowx"><label for="smtpUsername">Username</label><input id="smtpUsername" type="text"></div>
                        <div class="rowx"><label for="smtpPassword">Password</label><input id="smtpPassword" type="password"></div>
                        <div class="rowx"><label for="notificationEmail">Notification Email</label><input id="notificationEmail" type="email" placeholder="alerts@example.com"></div>
                        <div class="rowx">
                            <label></label>
                            <button class="btn btn-primary" onclick="testEmailSettings()">Test Email Settings</button>
                        </div>
                    </div>
                </div>

                <div class="email-settings">
                    <h4>Webhook Integrations</h4>
                    <div class="rowx">
                        <label for="webhookEnabled">Enable Webhooks</label>
                        <input type="checkbox" id="webhookEnabled" onchange="toggleWebhookSettings()">
                    </div>
                    <div id="webhookSettings" style="display: none;">
                        <div class="rowx"><label for="webhookUrl">Webhook URL</label><input id="webhookUrl" type="text" placeholder="https://hook.example.com/endpoint"></div>
                        <div class="rowx">
                            <label for="webhookEvents">Events to Send</label>
                            <select id="webhookEvents" multiple style="height: 100px;">
                                <option value="url_down">URL Down</option>
                                <option value="url_up">URL Up</option>
                                <option value="ssl_expiring">SSL Expiring</option>
                                <option value="ssl_expired">SSL Expired</option>
                                <option value="response_slow">Response Slow</option>
                            </select>
                        </div>
                        <div class="rowx">
                            <label></label>
                            <button class="btn btn-primary" onclick="testWebhook()">Test Webhook</button>
                        </div>
                        <div id="webhookTestResult" class="webhook-test"></div>
                    </div>
                </div>

                <div class="email-settings">
                    <h4>Slack Integration</h4>
                    <div class="rowx">
                        <label for="slackEnabled">Enable Slack Notifications</label>
                        <input type="checkbox" id="slackEnabled" onchange="toggleSlackSettings()">
                    </div>
                    <div id="slackSettings" style="display: none;">
                        <div class="rowx"><label for="slackWebhook">Slack Webhook URL</label><input id="slackWebhook" type="text" placeholder="https://hooks.slack.com/services/..."></div>
                        <div class="rowx"><label for="slackChannel">Slack Channel</label><input id="slackChannel" type="text" placeholder="#monitoring"></div>
                        <div class="rowx">
                            <label></label>
                            <button class="btn btn-primary" onclick="testSlack()">Test Slack</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="apiTab" class="tab-content">
            <div class="section">
                <h3 style="margin:0 0 15px 0;">API Access</h3>

                <div class="api-docs">
                    <h4>API Documentation</h4>
                    <p>Use the following endpoints to integrate with external systems:</p>

                    <div class="api-endpoint">GET /api/status</div>
                    <p>Returns current status of all monitored URLs</p>

                    <div class="api-endpoint">GET /api/status/{url}</div>
                    <p>Returns status of a specific URL</p>

                    <div class="api-endpoint">POST /api/check</div>
                    <p>Trigger an immediate check of all URLs</p>

                    <div class="api-endpoint">GET /api/alerts</div>
                    <p>Returns recent alerts</p>
                </div>

                <div style="margin-top: 20px;">
                    <h4>API Key</h4>
                    <div class="rowx">
                        <label for="apiKey">Your API Key:</label>
                        <div class="api-key" id="apiKeyDisplay">Generate API key to enable access</div>
                    </div>
                    <div class="rowx">
                        <label></label>
                        <button class="btn btn-primary" onclick="generateApiKey()">Generate API Key</button>
                        <button class="btn btn-gray" onclick="testApi()">Test API</button>
                    </div>
                    <div id="apiTestResult"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-backdrop" onclick="closeModal('settingsModal')">
    <div class="modal" role="dialog" onclick="event.stopPropagation()">
        <header>Settings</header>
        <div class="body">
            <div class="rowx"><label>Check Interval (sec)</label><input id="interval" type="number" min="10" /></div>
            <div class="rowx"><label>Timeout (ms)</label><input id="timeout" type="number" min="1000" /></div>
            <div class="rowx"><label>Max Endpoints (Inspector)</label><input id="maxEndpoints" type="number" min="5" /></div>
            <div class="rowx"><label>SSL Check Interval (days)</label><input id="sslCheckInterval" type="number" min="1" /></div>
            <div class="rowx"><label>SSL Expiry Warning (days)</label><input id="sslWarningDays" type="number" min="1" /></div>
            <div class="rowx"><label>Alert Sound</label><select id="alertSound"><option value="none">None</option><option value="beep">Beep</option><option value="bell">Bell</option></select></div>
            <div class="rowx"><label>Response Time Warning (ms)</label><input id="responseTimeWarning" type="number" min="100" value="1000" /></div>
            <div class="rowx"><label>Response Time Critical (ms)</label><input id="responseTimeCritical" type="number" min="100" value="3000" /></div>
            <div class="rowx"><label>Uptime Warning Threshold</label><input id="uptimeWarning" type="number" min="50" max="100" value="95" />%</div>
            <div class="rowx"><label>Retry Failed Checks</label><select id="retryFailed"><option value="0">No Retry</option><option value="1">1 Retry</option><option value="2">2 Retries</option><option value="3">3 Retries</option></select></div>
            <div class="rowx"><label>Enable Performance Charts</label><input id="enableCharts" type="checkbox" checked /></div>
            <div class="rowx"><label>Enable Public Status Page</label><input id="enableStatusPage" type="checkbox" /></div>
            <div class="rowx"><label>Multi-location Checks</label><input id="multiLocation" type="checkbox" /></div>
            <div class="rowx"><label>Auto Backup Interval (hours)</label><input id="autoBackup" type="number" min="0" value="0" /></div>
        </div>
        <footer>
            <button class="btn btn-gray" onclick="closeModal('settingsModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        </footer>
    </div>
</div>

<!-- Profile Manager Modal -->
<div id="profileModal" class="modal-backdrop" onclick="closeModal('profileModal')">
    <div class="modal" role="dialog" onclick="event.stopPropagation()">
        <header>Profile Management</header>
        <div class="body">
            <div class="rowx"><label for="newProfileName">New Profile Name</label><input id="newProfileName" type="text" placeholder="Enter profile name"></div>
            <button class="btn btn-primary" onclick="createProfile()">Create New Profile</button>

            <div style="margin-top: 20px;">
                <h4>Existing Profiles</h4>
                <div id="profileList" class="grid"></div>
            </div>
        </div>
        <footer>
            <button class="btn btn-gray" onclick="closeModal('profileModal')">Close</button>
        </footer>
    </div>
</div>

<!-- Add URL Modal -->
<div id="addUrlModal" class="modal-backdrop" onclick="closeModal('addUrlModal')">
    <div class="modal" role="dialog" onclick="event.stopPropagation()" style="width: 500px;">
        <header>Add New URL</header>
        <div class="body">
            <div class="rowx"><label for="newUrl">URL</label><input id="newUrl" type="text" placeholder="https://example.com"></div>
            <div class="rowx"><label for="urlTags">Tags</label><input id="urlTags" type="text" placeholder="production, api, frontend"></div>
            <div class="rowx"><label for="urlGroup">Group</label><input id="urlGroup" type="text" placeholder="Production Services"></div>
            <div class="rowx"><label for="customInterval">Custom Check Interval (sec)</label><input id="customInterval" type="number" min="10" placeholder="Use global setting"></div>
            <div class="rowx"><label for="expectedStatus">Expected Status Code</label><input id="expectedStatus" type="number" min="100" max="599" value="200"></div>
            <div class="rowx"><label for="urlDescription">Description</label><input id="urlDescription" type="text" placeholder="Optional description"></div>
        </div>
        <footer>
            <button class="btn btn-gray" onclick="closeModal('addUrlModal')">Cancel</button>
            <button class="btn btn-primary" onclick="addNewURL()">Add URL</button>
        </footer>
    </div>
</div>

<!-- Incident Modal -->
<div id="incidentModal" class="modal-backdrop" onclick="closeModal('incidentModal')">
    <div class="modal" role="dialog" onclick="event.stopPropagation()" style="width: 600px;">
        <header id="incidentModalHeader">Create Incident</header>
        <div class="body">
            <div class="rowx"><label for="incidentTitle">Title</label><input id="incidentTitle" type="text" placeholder="Brief description of the incident"></div>
            <div class="rowx"><label for="incidentUrls">Affected URLs</label><select id="incidentUrls" multiple style="height: 100px;"></select></div>
            <div class="rowx"><label for="incidentSeverity">Severity</label>
                <select id="incidentSeverity">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="rowx"><label for="incidentDescription">Description</label><textarea id="incidentDescription" rows="4" placeholder="Detailed description of the incident"></textarea></div>
        </div>
        <footer>
            <button class="btn btn-gray" onclick="closeModal('incidentModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveIncident()">Save Incident</button>
        </footer>
    </div>
</div>

<!-- Inspector Modal -->
<div id="inspectorModal" class="modal-backdrop" onclick="closeModal('inspectorModal')">
    <div class="modal" role="dialog" onclick="event.stopPropagation()">
        <header>Auto Inspector</header>
        <div class="body">
            <div>
                <b>1. Select a URL to inspect for related endpoints</b>
                <div id="inspectorSourceList" class="grid" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 8px; border-radius: 8px; margin-top: 8px;"></div>
            </div>
            <div style="margin-top: 16px;">
                <b>Inspection Options</b>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
                    <label><input type="checkbox" id="deepScan" checked> Deep Scan (slower)</label>
                    <label><input type="checkbox" id="checkSubdomains" checked> Check Subdomains</label>
                    <label><input type="checkbox" id="checkCommonPaths" checked> Common Paths</label>
                    <label><input type="checkbox" id="checkAPIs" checked> API Endpoints</label>
                    <label><input type="checkbox" id="checkFiles" checked> Common Files</label>
                </div>
            </div>
            <div id="inspectorResults" style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                <b>2. Found Endpoints</b>
                <div id="inspectorResultList" style="margin-top: 8px;">Select a source URL and click "Start Inspection".</div>
            </div>
        </div>
        <footer>
            <button class="btn btn-gray" onclick="closeModal('inspectorModal')">Close</button>
            <button id="startScanBtn" class="btn btn-primary" onclick="startInspectorScan()">Start Inspection</button>
        </footer>
    </div>
</div>

<!-- URL Details Modal -->
<div id="urlDetailsModal" class="modal-backdrop" onclick="closeModal('urlDetailsModal')">
    <div class="modal" role="dialog" onclick="event.stopPropagation()" style="width: 800px;">
        <header id="urlDetailsHeader">URL Details</header>
        <div class="body">
            <div id="urlDetailsContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
        <footer>
            <button class="btn btn-gray" onclick="closeModal('urlDetailsModal')">Close</button>
        </footer>
    </div>
</div>

<!-- Status Page Preview -->
<div id="statusPageModal" class="modal-backdrop" onclick="closeModal('statusPageModal')">
    <div class="modal" role="dialog" onclick="event.stopPropagation()" style="width: 800px;">
        <header>Status Page Preview</header>
        <div class="body">
            <div class="status-page-preview">
                <h3 style="text-align: center; margin-bottom: 20px;">System Status</h3>
                <div id="statusPageContent">
                    <!-- Status page content will be populated here -->
                </div>
            </div>
            <div style="margin-top: 20px;">
                <p class="small">Share this URL for public access: <span id="statusPageUrl" style="font-family: monospace;"></span></p>
                <button class="btn btn-primary" onclick="copyStatusPageUrl()">Copy URL</button>
            </div>
        </div>
        <footer>
            <button class="btn btn-gray" onclick="closeModal('statusPageModal')">Close</button>
        </footer>
    </div>
</div>

<!-- Theme Toggle -->
<button class="theme-toggle" onclick="toggleDarkMode()">🌙</button>

<script>
    // =============== State & Persistence ===============
    const DEFAULT_SETTINGS = {
        intervalSec: 60,
        timeoutMs: 8000,
        maxInspectorEndpoints: 20,
        sslCheckInterval: 1,
        sslWarningDays: 30,
        alertSound: 'none',
        responseTimeWarning: 1000,
        responseTimeCritical: 3000,
        uptimeWarning: 95,
        retryFailed: 0,
        enableCharts: true,
        darkMode: false,
        enableStatusPage: false,
        multiLocation: false,
        autoBackup: 0,
        emailEnabled: false,
        smtpServer: '',
        smtpPort: 587,
        smtpUsername: '',
        smtpPassword: '',
        notificationEmail: '',
        webhookEnabled: false,
        webhookUrl: '',
        webhookEvents: ['url_down', 'url_up'],
        slackEnabled: false,
        slackWebhook: '',
        slackChannel: ''
    };

    // DOM Elements
    const elements = {
        appContainer: document.getElementById('appContainer'),
        login: {
            modal: document.getElementById('loginModal'),
            username: document.getElementById('username'),
            password: document.getElementById('password'),
            error: document.getElementById('loginError')
        },
        modals: {
            settings: document.getElementById('settingsModal'),
            inspector: document.getElementById('inspectorModal'),
            urlDetails: document.getElementById('urlDetailsModal'),
            profile: document.getElementById('profileModal'),
            addUrl: document.getElementById('addUrlModal'),
            incident: document.getElementById('incidentModal'),
            statusPage: document.getElementById('statusPageModal')
        },
        urlList: document.getElementById('urlList'),
        alertList: document.getElementById('alertList'),
        incidentList: document.getElementById('incidentList'),
        stats: {
            total: document.getElementById('total'),
            online: document.getElementById('online'),
            offline: document.getElementById('offline'),
            sslIssues: document.getElementById('sslIssues'),
            uptime24: document.getElementById('uptime24'),
            avgRt24: document.getElementById('avgRt24'),
            healthScore: document.getElementById('healthScore')
        },
        inputs: {
            interval: document.getElementById('interval'),
            timeout: document.getElementById('timeout'),
            maxEndpoints: document.getElementById('maxEndpoints'),
            sslCheckInterval: document.getElementById('sslCheckInterval'),
            sslWarningDays: document.getElementById('sslWarningDays'),
            alertSound: document.getElementById('alertSound'),
            responseTimeWarning: document.getElementById('responseTimeWarning'),
            responseTimeCritical: document.getElementById('responseTimeCritical'),
            uptimeWarning: document.getElementById('uptimeWarning'),
            retryFailed: document.getElementById('retryFailed'),
            enableCharts: document.getElementById('enableCharts'),
            enableStatusPage: document.getElementById('enableStatusPage'),
            multiLocation: document.getElementById('multiLocation'),
            autoBackup: document.getElementById('autoBackup')
        },
        inspector: {
            sourceList: document.getElementById('inspectorSourceList'),
            resultList: document.getElementById('inspectorResultList'),
            startBtn: document.getElementById('startScanBtn')
        },
        alertBadge: document.getElementById('alertBadge'),
        searchUrls: document.getElementById('searchUrls'),
        statusFilter: document.getElementById('statusFilter'),
        tagFilter: document.getElementById('tagFilter'),
        sslFilter: document.getElementById('sslFilter'),
        profileSelect: document.getElementById('profileSelect')
    };

    // Global state
    let timer = null;
    let sslTimer = null;
    let backupTimer = null;
    let settings = { ...DEFAULT_SETTINGS };
    let urls = [];
    let alerts = [];
    let incidents = [];
    let profiles = {};
    let currentProfile = 'default';
    let apiKey = null;
    let selectedURLs = new Set();
    let allTags = new Set();
    let exportFormat = 'csv';
    let backupType = 'local';

    // =============== Utility Functions ===============
    const normalizeUrl = (input) => {
        try {
            let u = (input || '').trim();
            if (!u) return null;
            return new URL(u.startsWith('http') ? u : `https://${u}`).toString();
        } catch {
            return null;
        }
    };

    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    const average = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;

    const now = () => Date.now();

    const DAY_MS = 24 * 60 * 60 * 1000;

    const prune = (arr, key) => (arr || []).filter(item => (item[key] ?? item) >= now() - DAY_MS);

    const addHistory = (item, status, rt) => {
        item.history = prune(item.history, 't');
        item.history.push({ t: now(), status, rt: typeof rt === 'number' ? rt : null });
    };

    const loadFromStorage = (key, fallback) => {
        try {
            const profileData = localStorage.getItem(`ump_${currentProfile}_${key}`);
            if (profileData) return JSON.parse(profileData);

            const globalData = localStorage.getItem(`ump_${key}`);
            return globalData ? JSON.parse(globalData) : fallback;
        } catch {
            return fallback;
        }
    };

    const persistUrls = () => localStorage.setItem(`ump_${currentProfile}_urls`, JSON.stringify(urls));
    const persistSettings = () => localStorage.setItem(`ump_${currentProfile}_settings`, JSON.stringify(settings));
    const persistAlerts = () => localStorage.setItem(`ump_${currentProfile}_alerts`, JSON.stringify(alerts));
    const persistIncidents = () => localStorage.setItem(`ump_${currentProfile}_incidents`, JSON.stringify(incidents));
    const persistProfiles = () => localStorage.setItem('ump_profiles', JSON.stringify(profiles));
    const persistApiKey = () => localStorage.setItem(`ump_${currentProfile}_apiKey`, JSON.stringify(apiKey));

    // =============== Authentication ===============
    const CREDENTIALS = { user: 'Faisal', pass: '456456f' };

    function handleLogin() {
        const user = elements.login.username.value;
        const pass = elements.login.password.value;
        if (user === CREDENTIALS.user && pass === CREDENTIALS.pass) {
            sessionStorage.setItem('isAuthenticated', 'true');
            elements.login.modal.style.display = 'none';
            elements.appContainer.style.display = 'block';
            initializeApp();
        } else {
            elements.login.error.textContent = 'Invalid credentials. Please try again.';
            elements.login.error.style.display = 'block';
        }
    }

    function handleLogout() {
        sessionStorage.removeItem('isAuthenticated');
        location.reload();
    }

    // Auto-login if session is active
    if (sessionStorage.getItem('isAuthenticated') === 'true') {
        elements.login.modal.style.display = 'none';
        elements.appContainer.style.display = 'block';
        initializeApp();
    }

    // =============== Core Monitoring Functions ===============
    function pingFavicon(url, timeoutMs) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            const start = performance.now();
            const timer = setTimeout(() => reject(new Error('Timeout')), timeoutMs);
            img.onload = () => { clearTimeout(timer); resolve({ rt: performance.now() - start }); };
            img.onerror = () => { clearTimeout(timer); reject(new Error('Image load error')); };
            try { img.src = `${new URL(url).origin}/favicon.ico?v=${now()}`; } catch (e) { reject(e); }
        });
    }

    async function checkSSLCertificate(url) {
        return new Promise((resolve) => {
            try {
                const hostname = new URL(url).hostname;
                // Simulate SSL expiry with random dates
                const today = new Date();
                const daysToExpiry = Math.floor(Math.random() * 60) + 1;
                const expiryDate = new Date(today);
                expiryDate.setDate(today.getDate() + daysToExpiry);

                resolve({
                    valid: true,
                    daysRemaining: daysToExpiry,
                    expiryDate: expiryDate.toISOString().split('T')[0],
                    issuer: "Simulated CA",
                    protocol: "TLS 1.3",
                    signatureAlgorithm: "SHA256-RSA"
                });
            } catch (error) {
                resolve({
                    valid: false,
                    daysRemaining: 0,
                    expiryDate: null,
                    issuer: null,
                    error: error.message
                });
            }
        });
    }

    async function checkUrl(item, retryCount = 0) {
        try {
            const { rt } = await pingFavicon(item.url, settings.timeoutMs);
            addHistory(item, 'online', rt);
            item.lastCheck = now();
            item.failCount = 0;

            // Check if SSL check is due
            const lastSSLCheck = item.lastSSLCheck || 0;
            const sslCheckDue = now() - lastSSLCheck > settings.sslCheckInterval * DAY_MS;

            if (sslCheckDue) {
                const sslResult = await checkSSLCertificate(item.url);
                item.sslInfo = sslResult;
                item.lastSSLCheck = now();

                // Check for SSL expiry warning
                if (sslResult.daysRemaining <= settings.sslWarningDays) {
                    addAlert(item.url, 'SSL Expiry Warning',
                        `SSL certificate for ${item.url} expires in ${sslResult.daysRemaining} days (${sslResult.expiryDate})`,
                        'warning');

                    // Send email notification for SSL expiry
                    if (settings.emailEnabled) {
                        sendEmailNotification(
                            'SSL Certificate Expiring Soon',
                            `SSL certificate for ${item.url} expires in ${sslResult.daysRemaining} days.`
                        );
                    }
                }
            }
        } catch (error) {
            addHistory(item, 'offline', null);
            item.failCount = (item.failCount || 0) + 1;

            // Retry logic
            if (retryCount < settings.retryFailed) {
                console.log(`Retrying ${item.url} (${retryCount + 1}/${settings.retryFailed})`);
                setTimeout(() => checkUrl(item, retryCount + 1), 2000);
                return;
            }

            addAlert(item.url, 'Connection Error', `Failed to connect to ${item.url}: ${error.message}`, 'error');

            // Send email notification for downtime
            if (settings.emailEnabled) {
                sendEmailNotification(
                    'Service Down Alert',
                    `The service at ${item.url} is currently down. Error: ${error.message}`
                );
            }

            console.warn(`Check failed for ${item.url}:`, error.message);
        }
    }

    async function checkAll() {
        await Promise.all(urls.map(checkUrl));
        persistUrls();
        render();
    }

    const startChecking = () => {
        stopChecking();
        if (settings.intervalSec > 0) {
            checkAll();
            timer = setInterval(checkAll, settings.intervalSec * 1000);
        }
    };

    const stopChecking = () => clearInterval(timer);

    // =============== Alert System ===============
    function addAlert(url, title, message, type = 'info') {
        const alert = {
            id: now() + Math.random(),
            timestamp: now(),
            url,
            title,
            message,
            type,
            read: false
        };

        alerts.unshift(alert);
        alerts = alerts.slice(0, 100);
        persistAlerts();
        updateAlertBadge();

        // Show notification if enabled
        if (settings.alertSound !== 'none') {
            showNotification(alert);
            playAlertSound();
        }

        // Send webhook if enabled
        if (settings.webhookEnabled) {
            sendWebhookNotification('alert', alert);
        }
    }

    function updateAlertBadge() {
        const unreadCount = alerts.filter(a => !a.read).length;
        if (unreadCount > 0) {
            elements.alertBadge.textContent = unreadCount;
            elements.alertBadge.style.display = 'flex';
        } else {
            elements.alertBadge.style.display = 'none';
        }
    }

    function showNotification(alert) {
        const notification = document.createElement('div');
        notification.className = `notification ${alert.type}`;
        notification.innerHTML = `
            <div>
                <strong>${escapeHtml(alert.title)}</strong>
                <div class="small">${escapeHtml(alert.message)}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">×</button>
        `;

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    function playAlertSound() {
        // In a real implementation, you would play actual sound files
        console.log('Alert sound would play here');
    }

    function showAlerts() {
        switchTab('alerts');
        // Mark all alerts as read when viewing
        alerts.forEach(alert => alert.read = true);
        persistAlerts();
        updateAlertBadge();
        renderAlerts();
    }

    function clearAlerts() {
        if (confirm('Are you sure you want to clear all alerts?')) {
            alerts = [];
            persistAlerts();
            updateAlertBadge();
            renderAlerts();
        }
    }

    function renderAlerts() {
        if (alerts.length === 0) {
            elements.alertList.innerHTML = '<div style="text-align:center; color: var(--muted); padding: 20px 0;">No alerts yet.</div>';
            return;
        }

        elements.alertList.innerHTML = alerts.map(alert => `
            <div class="row">
                <div class="dot" style="background:${alert.type === 'error' ? 'var(--danger)' : alert.type === 'warning' ? 'var(--warn)' : 'var(--primary)'}"></div>
                <div>
                    <div class="url">${escapeHtml(alert.title)}</div>
                    <div class="sub">${escapeHtml(alert.message)}</div>
                    <div class="sub">${new Date(alert.timestamp).toLocaleString()}</div>
                </div>
                <div class="right">
                    <div class="chip ${alert.type === 'error' ? 'chip-danger' : alert.type === 'warning' ? 'chip-warning' : ''}">${alert.type}</div>
                    <button onclick="deleteAlert(${alert.id})">🗑️</button>
                </div>
            </div>
        `).join('');
    }

    function deleteAlert(id) {
        alerts = alerts.filter(alert => alert.id !== id);
        persistAlerts();
        updateAlertBadge();
        renderAlerts();
    }

    // =============== UI Rendering ===============
    const renderTimeline = (history) => `<svg class="timeline" viewBox="0 0 96 10">${[...Array(96)].map((_, i) => {
        const entry = history.find(h => Math.floor((now() - h.t) / (15 * 60 * 1000)) === i);
        const color = !entry ? 'var(--border)' : entry.status === 'online' ? 'var(--success)' : 'var(--danger)';
        return `<rect x="${95-i}" y="0" width="1" height="10" fill="${color}" />`;
    }).join('')}</svg>`;

    const getSSLChipClass = (daysRemaining) => {
        if (daysRemaining <= 7) return 'chip-danger';
        if (daysRemaining <= 30) return 'chip-warning';
        return 'chip-success';
    };

    const renderURLList = (urlsToRender = urls) => {
        elements.urlList.innerHTML = urlsToRender.length ? urlsToRender.map(renderUrlRow).join('') :
            '<div style="text-align:center; color: var(--muted); padding: 20px 0;">No URLs match the current filters.</div>';
    };

    const renderUrlRow = (item) => {
        const last = item.history?.slice(-1)[0] ?? {};
        const statusClass = last.status === 'online' ? 'success' : last.status === 'offline' ? 'danger' : 'muted';
        const rtText = typeof last.rt === 'number' ? `${Math.round(last.rt)}ms` : '—';

        // Determine response time status
        let rtStatus = '';
        if (last.status === 'online' && typeof last.rt === 'number') {
            if (last.rt > settings.responseTimeCritical) {
                rtStatus = 'chip-danger';
            } else if (last.rt > settings.responseTimeWarning) {
                rtStatus = 'chip-warning';
            }
        }

        // SSL info
        let sslHtml = '';
        if (item.sslInfo) {
            const sslClass = getSSLChipClass(item.sslInfo.daysRemaining);
            sslHtml = `<div class="chip ${sslClass}" title="SSL expires on ${item.sslInfo.expiryDate}">SSL: ${item.sslInfo.daysRemaining}d</div>`;
        }

        // Tags
        let tagsHtml = '';
        if (item.tags && item.tags.length) {
            tagsHtml = `<div class="tag-group">${item.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>`;
        }

        // Group
        let groupHtml = '';
        if (item.group) {
            groupHtml = `<div class="sub">Group: ${item.group}</div>`;
        }

        return `
            <div class="row" data-url="${escapeHtml(item.url)}">
                <input type="checkbox" class="url-checkbox" ${selectedURLs.has(item.url) ? 'checked' : ''} onchange="toggleURLSelection('${escapeHtml(item.url)}', this.checked)">
                <div class="dot" style="background:var(--${statusClass})"></div>
                <div style="flex: 1;">
                    <div class="url">${escapeHtml(item.url)}</div>
                    <div class="sub">Status: <b class="${statusClass}">${last.status || 'pending'}</b> | Last check: ${last.t ? new Date(last.t).toLocaleTimeString() : 'N/A'}</div>
                    ${item.description ? `<div class="sub">${item.description}</div>` : ''}
                    ${groupHtml}
                    ${item.sslInfo ? `<div class="sub">SSL: Expires on ${item.sslInfo.expiryDate} (${item.sslInfo.daysRemaining} days remaining)</div>` : ''}
                    ${tagsHtml}
                </div>
                <div class="right">
                    ${renderTimeline(item.history || [])}
                    <div class="chip ${rtStatus}">${rtText}</div>
                    ${sslHtml}
                    <div class="url-actions">
                        <button onclick="showURLDetails('${escapeHtml(item.url)}')">📊</button>
                        <button onclick="deleteURL('${escapeHtml(item.url)}')">🗑️</button>
                    </div>
                </div>
            </div>`;
    };

    function renderStats() {
        const onlineCount = urls.filter(u => u.history?.slice(-1)[0]?.status === 'online').length;
        const sslIssueCount = urls.filter(u => u.sslInfo && u.sslInfo.daysRemaining <= settings.sslWarningDays).length;
        const allHistory = urls.flatMap(u => u.history || []);
        const recentHistory = prune(allHistory, 't');
        const recentOnline = recentHistory.filter(h => h.status === 'online');
        const uptime = recentHistory.length ? (recentOnline.length / recentHistory.length * 100).toFixed(1) : '0.0';
        const validRts = recentOnline.map(h => h.rt).filter(rt => rt != null);
        const avgRt = average(validRts);
        const healthScore = calculateHealthScore();

        elements.stats.total.textContent = urls.length;
        elements.stats.online.textContent = onlineCount;
        elements.stats.offline.textContent = urls.length - onlineCount;
        elements.stats.sslIssues.textContent = sslIssueCount;
        elements.stats.uptime24.textContent = `${uptime}%`;
        elements.stats.avgRt24.textContent = avgRt != null ? `${Math.round(avgRt)}ms` : '—';
        elements.stats.healthScore.textContent = `${healthScore}%`;
    }

    const render = () => {
        renderURLList();
        renderStats();
        updateTagsList();
        renderIncidents();
    };

    // =============== NEW FEATURES ===============

    // 1. Profile Management
    function initializeProfiles() {
        profiles = loadFromStorage('profiles', {});
        if (Object.keys(profiles).length === 0) {
            profiles = {
                'default': {
                    name: 'Default Profile',
                    created: Date.now(),
                    urls: [],
                    settings: {...DEFAULT_SETTINGS},
                    alerts: [],
                    incidents: []
                }
            };
            persistProfiles();
        }

        // Set current profile
        currentProfile = 'default';

        // Populate profile selector
        updateProfileSelector();
    }

    function updateProfileSelector() {
        elements.profileSelect.innerHTML = '';
        Object.keys(profiles).forEach(profileId => {
            const option = document.createElement('option');
            option.value = profileId;
            option.textContent = profiles[profileId].name;
            if (profileId === currentProfile) option.selected = true;
            elements.profileSelect.appendChild(option);
        });
    }

    function switchProfile(profileId) {
        // Save current state
        if (currentProfile) {
            profiles[currentProfile].urls = urls;
            profiles[currentProfile].settings = settings;
            profiles[currentProfile].alerts = alerts;
            profiles[currentProfile].incidents = incidents;
        }

        // Load new profile
        currentProfile = profileId;
        urls = profiles[profileId].urls || [];
        settings = {...DEFAULT_SETTINGS, ...profiles[profileId].settings};
        alerts = profiles[profileId].alerts || [];
        incidents = profiles[profileId].incidents || [];
        apiKey = loadFromStorage('apiKey', null);

        // Update UI
        render();
        updateAlertBadge();
        updateTagsList();
        startChecking();

        persistProfiles();
    }

    function showProfileManager() {
        // Populate profile list
        const profileList = document.getElementById('profileList');
        profileList.innerHTML = '';

        Object.keys(profiles).forEach(profileId => {
            const profile = profiles[profileId];
            const profileElement = document.createElement('div');
            profileElement.className = 'row';
            profileElement.innerHTML = `
                <div style="flex: 1;">
                    <div class="url">${profile.name}</div>
                    <div class="sub">URLs: ${profile.urls?.length || 0} | Created: ${new Date(profile.created).toLocaleDateString()}</div>
                </div>
                <div class="right">
                    <button onclick="switchProfile('${profileId}')">Switch</button>
                    <button onclick="renameProfile('${profileId}')">Rename</button>
                    <button onclick="deleteProfile('${profileId}')">Delete</button>
                </div>
            `;
            profileList.appendChild(profileElement);
        });

        elements.modals.profile.style.display = 'flex';
    }

    function createProfile() {
        const name = document.getElementById('newProfileName').value;
        if (!name) return alert('Please enter a profile name');

        const profileId = 'profile_' + Date.now();
        profiles[profileId] = {
            name: name,
            created: Date.now(),
            urls: [],
            settings: {...DEFAULT_SETTINGS},
            alerts: [],
            incidents: []
        };

        persistProfiles();
        updateProfileSelector();
        document.getElementById('newProfileName').value = '';

        // Switch to new profile
        switchProfile(profileId);
    }

    function renameProfile(profileId) {
        const newName = prompt('Enter new profile name:', profiles[profileId].name);
        if (newName) {
            profiles[profileId].name = newName;
            persistProfiles();
            updateProfileSelector();
            showProfileManager();
        }
    }

    function deleteProfile(profileId) {
        if (Object.keys(profiles).length <= 1) {
            return alert('You cannot delete the last profile');
        }

        if (confirm(`Are you sure you want to delete profile "${profiles[profileId].name}"?`)) {
            delete profiles[profileId];
            persistProfiles();

            // Switch to another profile
            const remainingProfiles = Object.keys(profiles);
            if (remainingProfiles.length > 0) {
                switchProfile(remainingProfiles[0]);
            }

            showProfileManager();
        }
    }

    function syncProfiles() {
        alert('Profile sync would connect to cloud storage in a real implementation');
    }

    // 2. Email Notifications
    function toggleEmailSettings() {
        const emailEnabled = document.getElementById('emailEnabled').checked;
        document.getElementById('emailSettings').style.display = emailEnabled ? 'block' : 'none';
    }

    function testEmailSettings() {
        const smtpServer = document.getElementById('smtpServer').value;
        const notificationEmail = document.getElementById('notificationEmail').value;

        if (!smtpServer || !notificationEmail) {
            return alert('Please fill in all required email settings');
        }

        alert('Email settings test would validate SMTP connection in a real implementation');
    }

    function sendEmailNotification(subject, message) {
        if (!settings.emailEnabled) return;

        console.log('Would send email:', subject, message);

        showNotification({
            title: 'Email Sent',
            message: `Email notification: ${subject}`,
            type: 'success'
        });
    }

    // 3. Webhook Integrations
    function toggleWebhookSettings() {
        const webhookEnabled = document.getElementById('webhookEnabled').checked;
        document.getElementById('webhookSettings').style.display = webhookEnabled ? 'block' : 'none';
    }

    function testWebhook() {
        const webhookUrl = document.getElementById('webhookUrl').value;

        if (!webhookUrl) {
            return alert('Please enter a webhook URL');
        }

        const testResult = document.getElementById('webhookTestResult');
        testResult.innerHTML = '<div class="api-test-success">Webhook test would be implemented in a real application</div>';
    }

    function sendWebhookNotification(event, data) {
        if (!settings.webhookEnabled) return;

        console.log('Would send webhook:', event, data);
    }

    // 4. Slack Integration
    function toggleSlackSettings() {
        const slackEnabled = document.getElementById('slackEnabled').checked;
        document.getElementById('slackSettings').style.display = slackEnabled ? 'block' : 'none';
    }

    function testSlack() {
        const slackWebhook = document.getElementById('slackWebhook').value;

        if (!slackWebhook) {
            return alert('Please enter a Slack webhook URL');
        }

        alert('Slack test would send a test message in a real implementation');
    }

    function sendSlackNotification(message) {
        if (!settings.slackEnabled) return;

        console.log('Would send Slack message:', message);
    }

    // 5. API Access
    function generateApiKey() {
        apiKey = 'ump_' + Math.random().toString(36).substring(2) + '_' + Date.now().toString(36);
        document.getElementById('apiKeyDisplay').textContent = apiKey;
        persistApiKey();

        showNotification({
            title: 'API Key Generated',
            message: 'New API key has been generated successfully',
            type: 'success'
        });
    }

    function testApi() {
        if (!apiKey) {
            return alert('Please generate an API key first');
        }

        const testResult = document.getElementById('apiTestResult');
        testResult.innerHTML = '<div class="api-test-success">API test would be implemented in a real application</div>';
    }

    // 6. Incident Management
    function createIncident() {
        // Populate URLs dropdown
        const incidentUrls = document.getElementById('incidentUrls');
        incidentUrls.innerHTML = '';
        urls.forEach(url => {
            const option = document.createElement('option');
            option.value = url.url;
            option.textContent = url.url;
            incidentUrls.appendChild(option);
        });

        document.getElementById('incidentModalHeader').textContent = 'Create Incident';
        document.getElementById('incidentTitle').value = '';
        document.getElementById('incidentDescription').value = '';
        document.getElementById('incidentSeverity').value = 'medium';

        elements.modals.incident.style.display = 'flex';
    }

    function saveIncident() {
        const title = document.getElementById('incidentTitle').value;
        const description = document.getElementById('incidentDescription').value;
        const severity = document.getElementById('incidentSeverity').value;
        const selectedUrls = Array.from(document.getElementById('incidentUrls').selectedOptions).map(opt => opt.value);

        if (!title) {
            return alert('Please enter an incident title');
        }

        const incident = {
            id: Date.now().toString(),
            title: title,
            description: description,
            severity: severity,
            urls: selectedUrls,
            status: 'open',
            createdAt: Date.now(),
            updatedAt: Date.now()
        };

        incidents.unshift(incident);
        persistIncidents();
        renderIncidents();

        elements.modals.incident.style.display = 'none';

        // Send notifications
        sendEmailNotification(`New Incident: ${title}`, `A new ${severity} severity incident has been created.`);
        sendSlackNotification(`New Incident: ${title} (${severity})`);
    }

    function renderIncidents() {
        if (incidents.length === 0) {
            elements.incidentList.innerHTML = '<div style="text-align:center; color: var(--muted); padding: 20px 0;">No incidents recorded.</div>';
            return;
        }

        elements.incidentList.innerHTML = incidents.map(incident => `
            <div class="incident-item ${incident.status === 'resolved' ? 'incident-resolved' : ''}">
                <div style="display: flex; justify-content: between; align-items: center;">
                    <h4 style="margin: 0; flex: 1;">${incident.title}</h4>
                    <span class="chip ${incident.severity === 'critical' ? 'chip-danger' : incident.severity === 'high' ? 'chip-warning' : 'chip'}">${incident.severity}</span>
                </div>
                <div class="sub">Created: ${new Date(incident.createdAt).toLocaleString()} | Status: ${incident.status}</div>
                <p>${incident.description}</p>
                <div class="incident-actions">
                    <button class="btn btn-gray" onclick="updateIncidentStatus('${incident.id}', '${incident.status === 'open' ? 'resolved' : 'open'}')">
                        ${incident.status === 'open' ? 'Resolve' : 'Reopen'}
                    </button>
                    <button class="btn btn-red" onclick="deleteIncident('${incident.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function updateIncidentStatus(id, newStatus) {
        const incident = incidents.find(i => i.id === id);
        if (incident) {
            incident.status = newStatus;
            incident.updatedAt = Date.now();
            persistIncidents();
            renderIncidents();

            sendEmailNotification(`Incident ${newStatus}: ${incident.title}`, `Incident "${incident.title}" has been ${newStatus}.`);
        }
    }

    function deleteIncident(id) {
        if (confirm('Are you sure you want to delete this incident?')) {
            incidents = incidents.filter(i => i.id !== id);
            persistIncidents();
            renderIncidents();
        }
    }

    // 7. Backup and Restore
    function selectBackupOption(element, type) {
        document.querySelectorAll('.backup-option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        backupType = type;
    }

    function createBackup() {
        const backupData = {
            version: '1.0',
            timestamp: Date.now(),
            profile: currentProfile,
            data: {
                urls: urls,
                settings: settings,
                alerts: alerts,
                incidents: incidents,
                profiles: profiles
            }
        };

        const dataStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `url-monitor-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        const backupStatus = document.getElementById('backupStatus');
        backupStatus.innerHTML = '<span class="backup-success">Backup created successfully</span>';

        setTimeout(() => {
            backupStatus.innerHTML = '';
        }, 3000);
    }

    function restoreBackup() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const backupData = JSON.parse(event.target.result);

                    if (confirm('Restoring backup will replace all current data. Are you sure?')) {
                        urls = backupData.data.urls || [];
                        settings = {...DEFAULT_SETTINGS, ...backupData.data.settings};
                        alerts = backupData.data.alerts || [];
                        incidents = backupData.data.incidents || [];
                        profiles = backupData.data.profiles || profiles;

                        persistUrls();
                        persistSettings();
                        persistAlerts();
                        persistIncidents();
                        persistProfiles();

                        render();
                        updateAlertBadge();
                        updateTagsList();
                        startChecking();

                        const backupStatus = document.getElementById('backupStatus');
                        backupStatus.innerHTML = '<span class="backup-success">Backup restored successfully</span>';

                        setTimeout(() => {
                            backupStatus.innerHTML = '';
                        }, 3000);
                    }
                } catch (error) {
                    alert('Error restoring backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        fileInput.click();
    }

    // 8. Status Page
    function showStatusPage() {
        if (!settings.enableStatusPage) {
            return alert('Please enable status page in settings first');
        }

        // Generate status page URL
        const statusPageUrl = `${window.location.origin}${window.location.pathname}#status-${currentProfile}`;
        document.getElementById('statusPageUrl').textContent = statusPageUrl;

        // Generate status page content
        const statusPageContent = document.getElementById('statusPageContent');
        statusPageContent.innerHTML = '';

        urls.forEach(url => {
            const lastStatus = url.history?.slice(-1)[0] || {};
            const statusItem = document.createElement('div');
            statusItem.className = 'status-page-item';
            statusItem.innerHTML = `
                <div>
                    <strong>${url.url}</strong>
                    <div class="sub">${url.description || 'No description'}</div>
                </div>
                <div class="chip ${lastStatus.status === 'online' ? 'chip-success' : 'chip-danger'}">
                    ${lastStatus.status === 'online' ? 'Operational' : 'Outage'}
                </div>
            `;
            statusPageContent.appendChild(statusItem);
        });

        elements.modals.statusPage.style.display = 'flex';
    }

    function copyStatusPageUrl() {
        const statusPageUrl = document.getElementById('statusPageUrl').textContent;
        navigator.clipboard.writeText(statusPageUrl).then(() => {
            showNotification({
                title: 'URL Copied',
                message: 'Status page URL copied to clipboard',
                type: 'success'
            });
        });
    }

    // 9. Enhanced URL Adding
    function showAddURLModal() {
        elements.modals.addUrl.style.display = 'flex';
    }

    function addNewURL() {
        const url = document.getElementById('newUrl').value;
        const tags = document.getElementById('urlTags').value.split(',').map(t => t.trim()).filter(t => t);
        const group = document.getElementById('urlGroup').value;
        const customInterval = document.getElementById('customInterval').value;
        const expectedStatus = document.getElementById('expectedStatus').value;
        const description = document.getElementById('urlDescription').value;

        if (!url) {
            return alert('Please enter a URL');
        }

        const normalizedUrl = normalizeUrl(url);
        if (!normalizedUrl) {
            return alert('Please enter a valid URL');
        }

        if (urls.some(u => u.url === normalizedUrl)) {
            return alert('This URL is already being monitored.');
        }

        const newUrl = {
            url: normalizedUrl,
            history: [],
            spikes: [],
            tags: tags,
            group: group || null,
            customInterval: customInterval ? parseInt(customInterval) : null,
            expectedStatus: expectedStatus ? parseInt(expectedStatus) : 200,
            description: description || null,
            lastCheck: null,
            failCount: 0
        };

        urls.push(newUrl);
        persistUrls();
        render();
        updateTagsList();

        // Check the new URL
        checkUrl(newUrl).then(() => {
            persistUrls();
            render();
        });

        elements.modals.addUrl.style.display = 'none';

        // Reset form
        document.getElementById('newUrl').value = '';
        document.getElementById('urlTags').value = '';
        document.getElementById('urlGroup').value = '';
        document.getElementById('customInterval').value = '';
        document.getElementById('expectedStatus').value = '200';
        document.getElementById('urlDescription').value = '';
    }

    // 10. Auto Backup
    function setupAutoBackup() {
        if (backupTimer) {
            clearInterval(backupTimer);
        }

        if (settings.autoBackup > 0) {
            const intervalMs = settings.autoBackup * 60 * 60 * 1000;
            backupTimer = setInterval(() => {
                createBackup();
            }, intervalMs);
        }
    }

    // =============== Additional Features ===============

    // Filter URLs
    function filterURLs() {
        const searchTerm = elements.searchUrls.value.toLowerCase();
        const statusFilter = elements.statusFilter.value;
        const tagFilter = elements.tagFilter.value;
        const sslFilter = elements.sslFilter.value;

        const filteredUrls = urls.filter(url => {
            // Search filter
            if (searchTerm && !url.url.toLowerCase().includes(searchTerm)) return false;

            // Status filter
            if (statusFilter !== 'all') {
                const lastStatus = url.history?.slice(-1)[0]?.status;
                if (statusFilter === 'online' && lastStatus !== 'online') return false;
                if (statusFilter === 'offline' && lastStatus !== 'offline') return false;
            }

            // Tag filter
            if (tagFilter !== 'all' && (!url.tags || !url.tags.includes(tagFilter))) return false;

            // SSL filter
            if (sslFilter !== 'all') {
                if (sslFilter === 'expiring' && (!url.sslInfo || url.sslInfo.daysRemaining > settings.sslWarningDays)) return false;
                if (sslFilter === 'valid' && (!url.sslInfo || url.sslInfo.daysRemaining <= settings.sslWarningDays)) return false;
            }

            return true;
        });

        renderURLList(filteredUrls);
    }

    // Batch Operations
    function selectAllURLs() {
        selectedURLs = new Set(urls.map(url => url.url));
        render();
    }

    function deselectAllURLs() {
        selectedURLs.clear();
        render();
    }

    function checkSelectedURLs() {
        const selected = urls.filter(url => selectedURLs.has(url.url));
        Promise.all(selected.map(checkUrl)).then(() => {
            persistUrls();
            render();
        });
    }

    function deleteSelectedURLs() {
        if (selectedURLs.size === 0) return;
        if (confirm(`Are you sure you want to delete ${selectedURLs.size} URL(s)?`)) {
            urls = urls.filter(url => !selectedURLs.has(url.url));
            selectedURLs.clear();
            persistUrls();
            render();
        }
    }

    // URL Details View
    function showURLDetails(url) {
        const urlData = urls.find(u => u.url === url);
        if (!urlData) return;

        elements.modals.urlDetails.style.display = 'flex';
        document.getElementById('urlDetailsHeader').textContent = `Details: ${url}`;

        const lastStatus = urlData.history?.slice(-1)[0] || {};
        const uptime24h = calculateUptime(urlData.history || [], 24);
        const avgResponseTime = calculateAverageResponseTime(urlData.history || []);

        let detailsHTML = `
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label">Current Status</div>
                    <div class="detail-value">
                        <span class="status-dot" style="background: ${lastStatus.status === 'online' ? 'var(--success)' : 'var(--danger)'}"></span>
                        ${lastStatus.status || 'Unknown'}
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Last Check</div>
                    <div class="detail-value">${lastStatus.t ? new Date(lastStatus.t).toLocaleString() : 'Never'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Response Time</div>
                    <div class="detail-value">${typeof lastStatus.rt === 'number' ? `${Math.round(lastStatus.rt)}ms` : '—'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Uptime (24h)</div>
                    <div class="detail-value">${uptime24h}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Avg Response Time</div>
                    <div class="detail-value">${avgResponseTime ? `${Math.round(avgResponseTime)}ms` : '—'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Checks</div>
                    <div class="detail-value">${urlData.history?.length || 0}</div>
                </div>
            </div>
        `;

        if (urlData.sslInfo) {
            detailsHTML += `
                <div style="margin-top: 20px;">
                    <h4>SSL Certificate Information</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Valid</div>
                            <div class="detail-value">${urlData.sslInfo.valid ? 'Yes' : 'No'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Days Remaining</div>
                            <div class="detail-value">${urlData.sslInfo.daysRemaining}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Expiry Date</div>
                            <div class="detail-value">${urlData.sslInfo.expiryDate || '—'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Issuer</div>
                            <div class="detail-value">${urlData.sslInfo.issuer || '—'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        document.getElementById('urlDetailsContent').innerHTML = detailsHTML;
    }

    // Health Score Calculation
    function calculateHealthScore() {
        if (urls.length === 0) return 0;

        let totalScore = 0;
        urls.forEach(url => {
            let urlScore = 0;

            // Status score (50%)
            const lastStatus = url.history?.slice(-1)[0]?.status;
            if (lastStatus === 'online') urlScore += 50;

            // Response time score (30%)
            const lastRT = url.history?.slice(-1)[0]?.rt;
            if (typeof lastRT === 'number') {
                if (lastRT <= settings.responseTimeWarning) urlScore += 30;
                else if (lastRT <= settings.responseTimeCritical) urlScore += 15;
            }

            // SSL score (20%)
            if (url.sslInfo && url.sslInfo.valid && url.sslInfo.daysRemaining > settings.sslWarningDays) {
                urlScore += 20;
            } else if (url.sslInfo && url.sslInfo.valid) {
                urlScore += 10;
            }

            totalScore += urlScore;
        });

        return Math.round(totalScore / urls.length);
    }

    // Calculate uptime for a specific period
    function calculateUptime(history, hours) {
        const period = hours * 60 * 60 * 1000;
        const recentHistory = history.filter(h => h.t >= now() - period);
        if (recentHistory.length === 0) return 0;

        const onlineCount = recentHistory.filter(h => h.status === 'online').length;
        return Math.round((onlineCount / recentHistory.length) * 100);
    }

    // Calculate average response time
    function calculateAverageResponseTime(history) {
        const validRTs = history.map(h => h.rt).filter(rt => typeof rt === 'number');
        return average(validRTs);
    }

    // Export options selection
    function selectExportOption(element, format) {
        document.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        exportFormat = format;
    }

    // Enhanced export functionality
    function exportData() {
        const includeHistory = document.getElementById('includeHistory').checked;
        const includeSSL = document.getElementById('includeSSL').checked;

        let data, mimeType, filename;

        if (exportFormat === 'csv') {
            // Create CSV content
            const headers = ['URL', 'Status', 'Last Check', 'Response Time', 'Uptime (24h)', 'SSL Days Remaining', 'SSL Expiry Date'];
            const rows = urls.map(url => {
                const lastStatus = url.history?.slice(-1)[0] || {};
                const uptime24h = calculateUptime(url.history || [], 24);
                return [
                    url.url,
                    lastStatus.status || 'unknown',
                    lastStatus.t ? new Date(lastStatus.t).toLocaleString() : 'N/A',
                    lastStatus.rt || 'N/A',
                    `${uptime24h}%`,
                    url.sslInfo?.daysRemaining || 'N/A',
                    url.sslInfo?.expiryDate || 'N/A'
                ];
            });

            data = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            mimeType = 'text/csv';
            filename = 'url-monitor-export.csv';
        } else if (exportFormat === 'json') {
            // JSON format
            data = JSON.stringify({
                exportedAt: new Date().toISOString(),
                settings: settings,
                urls: urls.map(url => ({
                    url: url.url,
                    tags: url.tags || [],
                    status: url.history?.slice(-1)[0]?.status || 'unknown',
                    lastCheck: url.history?.slice(-1)[0]?.t || null,
                    responseTime: url.history?.slice(-1)[0]?.rt || null,
                    uptime24h: calculateUptime(url.history || [], 24),
                    sslInfo: includeSSL ? url.sslInfo || null : null,
                    history: includeHistory ? (url.history || []) : []
                }))
            }, null, 2);
            mimeType = 'application/json';
            filename = 'url-monitor-export.json';
        } else if (exportFormat === 'pdf') {
            alert('PDF export would be implemented with a library like jsPDF in a real application');
            return;
        } else if (exportFormat === 'html') {
            // Create a standalone HTML dashboard
            data = generateHTMLDashboard();
            mimeType = 'text/html';
            filename = 'url-monitor-dashboard.html';
        }

        // Create download link
        const blob = new Blob([data], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Show success message
        const exportResult = document.getElementById('exportResult');
        exportResult.innerHTML = `<div class="success">Data exported successfully as ${filename}</div>`;
        setTimeout(() => {
            exportResult.innerHTML = '';
        }, 3000);
    }

    // Generate HTML Dashboard for export
    function generateHTMLDashboard() {
        const onlineCount = urls.filter(u => u.history?.slice(-1)[0]?.status === 'online').length;
        const healthScore = calculateHealthScore();

        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>URL Monitor Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat { background: #f5f5f5; padding: 14px; border-radius: 10px; text-align: center; }
        .url-list { margin-top: 20px; }
        .url-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .online { border-left: 4px solid green; }
        .offline { border-left: 4px solid red; }
        .exported { text-align: center; color: #666; margin-top: 30px; }
    </style>
</head>
<body>
    <h1>URL Monitor Dashboard</h1>
    <div class="exported">Exported on ${new Date().toLocaleString()}</div>

    <div class="stats">
        <div class="stat"><div>Total URLs</div><div style="font-size: 24px; font-weight: bold;">${urls.length}</div></div>
        <div class="stat"><div>Online</div><div style="font-size: 24px; font-weight: bold; color: green;">${onlineCount}</div></div>
        <div class="stat"><div>Offline</div><div style="font-size: 24px; font-weight: bold; color: red;">${urls.length - onlineCount}</div></div>
        <div class="stat"><div>Health Score</div><div style="font-size: 24px; font-weight: bold;">${healthScore}%</div></div>
    </div>

    <div class="url-list">
        <h2>Monitored URLs</h2>
        ${urls.map(url => {
            const lastStatus = url.history?.slice(-1)[0] || {};
            return `
            <div class="url-item ${lastStatus.status === 'online' ? 'online' : 'offline'}">
                <div><strong>${url.url}</strong></div>
                <div>Status: ${lastStatus.status || 'unknown'} | Last Check: ${lastStatus.t ? new Date(lastStatus.t).toLocaleString() : 'N/A'}</div>
                <div>Response Time: ${typeof lastStatus.rt === 'number' ? `${Math.round(lastStatus.rt)}ms` : '—'}</div>
            </div>
            `;
        }).join('')}
    </div>
</body>
</html>
        `;
    }

    // Generate Reports
    function generateReport() {
        const healthScore = calculateHealthScore();
        const uptime7Days = calculateOverallUptime(7);
        const avgResponseTime = calculateOverallAverageResponseTime();
        const totalChecks24h = urls.reduce((sum, url) => sum + (url.history?.filter(h => h.t >= now() - DAY_MS).length || 0), 0);

        // Update health indicator
        const healthIndicator = document.getElementById('overallHealthIndicator');
        const healthProgress = document.getElementById('healthProgress');

        if (healthScore >= 80) {
            healthIndicator.className = 'health-indicator health-good';
            healthProgress.className = 'progress-fill';
        } else if (healthScore >= 60) {
            healthIndicator.className = 'health-indicator health-warning';
            healthProgress.className = 'progress-fill progress-warning';
        } else {
            healthIndicator.className = 'health-indicator health-critical';
            healthProgress.className = 'progress-fill progress-critical';
        }

        document.getElementById('overallHealthScore').textContent = `${healthScore}%`;
        document.getElementById('healthProgress').style.width = `${healthScore}%`;
        document.getElementById('uptime7Days').textContent = `${uptime7Days}%`;
        document.getElementById('avgResponseTime').textContent = avgResponseTime ? `${Math.round(avgResponseTime)}ms` : '—';
        document.getElementById('totalChecks24h').textContent = totalChecks24h;

        // Render endpoint health list
        const endpointHealthList = document.getElementById('endpointHealthList');
        endpointHealthList.innerHTML = urls.map(url => {
            const lastStatus = url.history?.slice(-1)[0] || {};
            const uptime24h = calculateUptime(url.history || [], 24);
            const avgRT = calculateAverageResponseTime(url.history || []);

            let healthClass = 'health-good';
            if (lastStatus.status !== 'online') {
                healthClass = 'health-critical';
            } else if (avgRT > settings.responseTimeCritical) {
                healthClass = 'health-critical';
            } else if (avgRT > settings.responseTimeWarning) {
                healthClass = 'health-warning';
            }

            return `
                <div class="collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <span>
                            <span class="health-indicator ${healthClass}"></span>
                            ${url.url}
                        </span>
                        <span>${uptime24h}% uptime</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Current Status</div>
                                <div class="detail-value">${lastStatus.status || 'Unknown'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Avg Response Time</div>
                                <div class="detail-value">${avgRT ? `${Math.round(avgRT)}ms` : '—'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Uptime (24h)</div>
                                <div class="detail-value">${uptime24h}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">SSL Status</div>
                                <div class="detail-value">${url.sslInfo ? (url.sslInfo.daysRemaining > settings.sslWarningDays ? 'Valid' : 'Expiring Soon') : 'Unknown'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Render performance chart if enabled
        if (settings.enableCharts) {
            renderPerformanceChart();
        }
    }

    // Calculate overall uptime
    function calculateOverallUptime(days) {
        const allHistory = urls.flatMap(u => u.history || []);
        const period = days * 24 * 60 * 60 * 1000;
        const recentHistory = allHistory.filter(h => h.t >= now() - period);
        if (recentHistory.length === 0) return 0;

        const onlineCount = recentHistory.filter(h => h.status === 'online').length;
        return Math.round((onlineCount / recentHistory.length) * 100);
    }

    // Calculate overall average response time
    function calculateOverallAverageResponseTime() {
        const allHistory = urls.flatMap(u => u.history || []);
        const validRTs = allHistory.map(h => h.rt).filter(rt => typeof rt === 'number');
        return average(validRTs);
    }

    // Render performance chart
    function renderPerformanceChart() {
        const chartContainer = document.getElementById('performanceChart');

        // Create a simple SVG chart
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "200");
        svg.setAttribute("viewBox", "0 0 300 200");

        // Get response time data for the last 24 hours
        const timeSlots = 24;
        const data = [];

        for (let i = 0; i < timeSlots; i++) {
            const time = now() - (timeSlots - i) * 60 * 60 * 1000;
            const endTime = time + 60 * 60 * 1000;

            const checksInSlot = urls.flatMap(u => u.history || [])
                .filter(h => h.t >= time && h.t < endTime && h.status === 'online' && typeof h.rt === 'number');

            if (checksInSlot.length > 0) {
                const avgRT = average(checksInSlot.map(h => h.rt));
                data.push(avgRT);
            } else {
                data.push(null);
            }
        }

        // Filter out null values and find max value for scaling
        const validData = data.filter(d => d !== null);
        const maxValue = validData.length > 0 ? Math.max(...validData) : 1000;

        // Draw chart
        for (let i = 0; i < data.length; i++) {
            if (data[i] === null) continue;

            const x = (i / (data.length - 1)) * 280 + 10;
            const y = 190 - (data[i] / maxValue) * 160;

            const circle = document.createElementNS(svgNS, "circle");
            circle.setAttribute("cx", x);
            circle.setAttribute("cy", y);
            circle.setAttribute("r", "3");
            circle.setAttribute("fill", data[i] > settings.responseTimeCritical ? "var(--danger)" :
                data[i] > settings.responseTimeWarning ? "var(--warn)" : "var(--success)");
            svg.appendChild(circle);

            if (i > 0 && data[i-1] !== null) {
                const prevX = ((i-1) / (data.length - 1)) * 280 + 10;
                const prevY = 190 - (data[i-1] / maxValue) * 160;

                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", prevX);
                line.setAttribute("y1", prevY);
                line.setAttribute("x2", x);
                line.setAttribute("y2", y);
                line.setAttribute("stroke", "#ccc");
                line.setAttribute("stroke-width", "1");
                svg.appendChild(line);
            }
        }

        // Add X axis (time labels)
        for (let i = 0; i < 5; i++) {
            const x = (i / 4) * 280 + 10;
            const hoursAgo = 24 - (i / 4) * 24;

            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", x);
            text.setAttribute("y", 195);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("font-size", "10");
            text.setAttribute("fill", "#666");
            text.textContent = `${Math.round(hoursAgo)}h ago`;
            svg.appendChild(text);
        }

        // Add Y axis (response time labels)
        for (let i = 0; i <= 4; i++) {
            const y = 190 - (i / 4) * 160;
            const value = Math.round((i / 4) * maxValue);

            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", 5);
            text.setAttribute("y", y + 3);
            text.setAttribute("text-anchor", "start");
            text.setAttribute("font-size", "10");
            text.setAttribute("fill", "#666");
            text.textContent = `${value}ms`;
            svg.appendChild(text);
        }

        chartContainer.innerHTML = '';
        chartContainer.appendChild(svg);
    }

    // Toggle collapsible sections
    function toggleCollapsible(header) {
        const content = header.nextElementSibling;
        if (content.style.display === 'block') {
            content.style.display = 'none';
        } else {
            content.style.display = 'block';
        }
    }

    // Dark mode toggle
    function toggleDarkMode() {
        settings.darkMode = !settings.darkMode;
        document.body.classList.toggle('dark-mode', settings.darkMode);
        persistSettings();

        // Update theme toggle button
        const themeToggle = document.querySelector('.theme-toggle');
        themeToggle.textContent = settings.darkMode ? '☀️' : '🌙';
    }

    // Toggle URL selection
    function toggleURLSelection(url, selected) {
        if (selected) {
            selectedURLs.add(url);
        } else {
            selectedURLs.delete(url);
        }
        render();
    }

    // Update tags list
    function updateTagsList() {
        allTags.clear();
        urls.forEach(url => {
            if (url.tags && url.tags.length) {
                url.tags.forEach(tag => allTags.add(tag));
            }
        });

        elements.tagFilter.innerHTML = '<option value="all">All Tags</option>';
        allTags.forEach(tag => {
            elements.tagFilter.innerHTML += `<option value="${tag}">${tag}</option>`;
        });
    }

    // Delete URL
    function deleteURL(url) {
        if (confirm('Are you sure you want to delete this URL?')) {
            urls = urls.filter(u => u.url !== url);
            selectedURLs.delete(url);
            persistUrls();
            render();
        }
    }

    // Show settings
    function showSettings() {
        // Populate settings form
        elements.inputs.interval.value = settings.intervalSec;
        elements.inputs.timeout.value = settings.timeoutMs;
        elements.inputs.maxEndpoints.value = settings.maxInspectorEndpoints;
        elements.inputs.sslCheckInterval.value = settings.sslCheckInterval;
        elements.inputs.sslWarningDays.value = settings.sslWarningDays;
        elements.inputs.alertSound.value = settings.alertSound;
        elements.inputs.responseTimeWarning.value = settings.responseTimeWarning;
        elements.inputs.responseTimeCritical.value = settings.responseTimeCritical;
        elements.inputs.uptimeWarning.value = settings.uptimeWarning;
        elements.inputs.retryFailed.value = settings.retryFailed;
        elements.inputs.enableCharts.checked = settings.enableCharts;
        elements.inputs.enableStatusPage.checked = settings.enableStatusPage;
        elements.inputs.multiLocation.checked = settings.multiLocation;
        elements.inputs.autoBackup.value = settings.autoBackup;

        // Set integration settings
        document.getElementById('emailEnabled').checked = settings.emailEnabled;
        document.getElementById('smtpServer').value = settings.smtpServer;
        document.getElementById('smtpPort').value = settings.smtpPort;
        document.getElementById('smtpUsername').value = settings.smtpUsername;
        document.getElementById('smtpPassword').value = settings.smtpPassword;
        document.getElementById('notificationEmail').value = settings.notificationEmail;

        document.getElementById('webhookEnabled').checked = settings.webhookEnabled;
        document.getElementById('webhookUrl').value = settings.webhookUrl;

        document.getElementById('slackEnabled').checked = settings.slackEnabled;
        document.getElementById('slackWebhook').value = settings.slackWebhook;
        document.getElementById('slackChannel').value = settings.slackChannel;

        // Toggle visibility
        toggleEmailSettings();
        toggleWebhookSettings();
        toggleSlackSettings();

        elements.modals.settings.style.display = 'flex';
    }

    // Save settings
    function saveSettings() {
        settings.intervalSec = parseInt(elements.inputs.interval.value, 10) || 60;
        settings.timeoutMs = parseInt(elements.inputs.timeout.value, 10) || 8000;
        settings.maxInspectorEndpoints = parseInt(elements.inputs.maxEndpoints.value, 10) || 20;
        settings.sslCheckInterval = parseInt(elements.inputs.sslCheckInterval.value, 10) || 1;
        settings.sslWarningDays = parseInt(elements.inputs.sslWarningDays.value, 10) || 30;
        settings.alertSound = elements.inputs.alertSound.value;
        settings.responseTimeWarning = parseInt(elements.inputs.responseTimeWarning.value, 10) || 1000;
        settings.responseTimeCritical = parseInt(elements.inputs.responseTimeCritical.value, 10) || 3000;
        settings.uptimeWarning = parseInt(elements.inputs.uptimeWarning.value, 10) || 95;
        settings.retryFailed = parseInt(elements.inputs.retryFailed.value, 10) || 0;
        settings.enableCharts = elements.inputs.enableCharts.checked;
        settings.enableStatusPage = elements.inputs.enableStatusPage.checked;
        settings.multiLocation = elements.inputs.multiLocation.checked;
        settings.autoBackup = parseInt(elements.inputs.autoBackup.value, 10) || 0;

        // Save integration settings
        settings.emailEnabled = document.getElementById('emailEnabled').checked;
        settings.smtpServer = document.getElementById('smtpServer').value;
        settings.smtpPort = parseInt(document.getElementById('smtpPort').value) || 587;
        settings.smtpUsername = document.getElementById('smtpUsername').value;
        settings.smtpPassword = document.getElementById('smtpPassword').value;
        settings.notificationEmail = document.getElementById('notificationEmail').value;

        settings.webhookEnabled = document.getElementById('webhookEnabled').checked;
        settings.webhookUrl = document.getElementById('webhookUrl').value;

        settings.slackEnabled = document.getElementById('slackEnabled').checked;
        settings.slackWebhook = document.getElementById('slackWebhook').value;
        settings.slackChannel = document.getElementById('slackChannel').value;

        persistSettings();
        closeModal('settingsModal');
        startChecking();
        setupAutoBackup();

        showNotification({
            title: 'Settings Saved',
            message: 'Your settings have been saved successfully',
            type: 'success'
        });
    }

    // Show inspector
    function showInspector() {
        elements.inspector.sourceList.innerHTML = urls.length ? urls.map((u, i) => `
            <label><input type="radio" name="inspectorSource" value="${escapeHtml(u.url)}" ${i===0 ? 'checked' : ''}>${escapeHtml(u.url)}</label>
        `).join('') : 'Add a URL first to use as an inspection source.';
        elements.inspector.resultList.innerHTML = 'Select a source URL and click "Start Inspection".';
        elements.modals.inspector.style.display = 'flex';
    }

    // Start inspector scan
    async function startInspectorScan() {
        const sourceRadio = document.querySelector('input[name="inspectorSource"]:checked');
        if (!sourceRadio) { alert('Please select a source URL to inspect.'); return; }

        elements.inspector.resultList.innerHTML = '<i>Inspecting... This may take a few moments.</i>';
        elements.inspector.startBtn.disabled = true;

        const sourceUrl = new URL(sourceRadio.value);
        const domainParts = sourceUrl.hostname.split('.');
        const mainDomain = domainParts.slice(Math.max(domainParts.length - 2, 0)).join('.');

        // Get inspection options
        const deepScan = document.getElementById('deepScan').checked;
        const checkSubdomains = document.getElementById('checkSubdomains').checked;
        const checkCommonPaths = document.getElementById('checkCommonPaths').checked;
        const checkAPIs = document.getElementById('checkAPIs').checked;
        const checkFiles = document.getElementById('checkFiles').checked;

        // Extended common subdomains and paths
        const commonSubdomains = ['www', 'api', 'app', 'dev', 'blog', 'shop', 'status', 'mail', 'cdn', 'prod', 'staging', 'docs',
            'admin', 'test', 'secure', 'portal', 'assets', 'static', 'media', 'img', 'images', 'js', 'css',
            'backend', 'frontend', 'mobile', 'web', 'support', 'help', 'forum', 'community', 'store', 'shop',
            'payment', 'billing', 'account', 'user', 'users', 'my', 'id', 'sso', 'auth', 'login', 'signin'];

        const commonPaths = ['/', '/status', '/blog', '/api/health', '/api', '/v1', '/v2', '/api/v1', '/api/v2', '/graphql', '/health',
            '/admin', '/dashboard', '/login', '/signin', '/register', '/signup', '/account', '/user', '/profile',
            '/docs', '/documentation', '/help', '/support', '/contact', '/about', '/privacy', '/terms', '/sitemap.xml',
            '/robots.txt', '/favicon.ico', '/manifest.json', '/.well-known/security.txt'];

        const apiPatterns = ['/api/', '/v1/', '/v2/', '/v3/', '/graphql', '/rest/', '/json/', '/xml/', '/soap/', '/ws/', '/wss/',
            '/oauth/', '/auth/', '/token/', '/user/', '/users/', '/account/', '/profile/', '/admin/', '/config/'];

        const commonFiles = ['/robots.txt', '/sitemap.xml', '/security.txt', '/humans.txt', '/ads.txt', '/.well-known/security.txt',
            '/.well-known/assetlinks.json', '/.well-known/apple-app-site-association', '/crossdomain.xml', '/clientaccesspolicy.xml'];

        // Build initial potential list
        let potentialUrls = [];

        if (checkSubdomains) {
            potentialUrls = commonSubdomains.map(sub => `https://${sub}.${mainDomain}`);
            potentialUrls.push(`https://${mainDomain}`);
        }

        if (checkCommonPaths) {
            potentialUrls = [...potentialUrls, ...commonPaths.map(path => `https://${mainDomain}${path}`)];
        }

        if (checkAPIs) {
            potentialUrls = [...potentialUrls, ...apiPatterns.map(pattern => `https://${mainDomain}${pattern}`)];
            // Also add API patterns to subdomains
            if (checkSubdomains) {
                commonSubdomains.forEach(sub => {
                    potentialUrls = [...potentialUrls, ...apiPatterns.map(pattern => `https://${sub}.${mainDomain}${pattern}`)];
                });
            }
        }

        if (checkFiles) {
            potentialUrls = [...potentialUrls, ...commonFiles.map(file => `https://${mainDomain}${file}`)];
        }

        // Normalize, dedupe and filter out existing monitored URLs
        let urlsToTest = [...new Set(potentialUrls.map(u => normalizeUrl(u)).filter(u => u && !urls.some(existing => existing.url === u)))];

        // Apply configured limit and hard cap of 100
        const configuredMax = parseInt(settings.maxInspectorEndpoints || DEFAULT_SETTINGS.maxInspectorEndpoints, 10) || DEFAULT_SETTINGS.maxInspectorEndpoints;
        const hardCap = 100;
        const maxToCheck = Math.min(urlsToTest.length, configuredMax, hardCap);

        if (maxToCheck === 0) {
            elements.inspector.resultList.innerHTML = 'No candidate endpoints to inspect (either none found or all are already monitored).';
            elements.inspector.startBtn.disabled = false;
            return;
        }

        let foundLinks = [];
        for (let i = 0; i < maxToCheck; i++) {
            const url = urlsToTest[i];
            elements.inspector.resultList.innerHTML = `<i>Inspecting (${i+1}/${maxToCheck}): ${escapeHtml(url)}</i>`;
            try {
                // quick ping using favicon (fast, lightweight)
                await pingFavicon(url, 3000);
                foundLinks.push({url, status: 'online'});
            } catch (e) {
                foundLinks.push({url, status: 'offline'});
            }
        }

        // Render results
        if (foundLinks.length === 0) {
            elements.inspector.resultList.innerHTML = 'No new, live endpoints were found for that domain.';
        } else {
            // Limit UI list to hardCap too
            const displayList = foundLinks.slice(0, hardCap);
            elements.inspector.resultList.innerHTML = displayList.map(link => `
                <div class="result-row" data-link="${escapeHtml(link.url)}">
                    <span>
                        <span class="status-dot" style="background: ${link.status === 'online' ? 'var(--success)' : 'var(--danger)'}"></span>
                        ${escapeHtml(link.url)}
                    </span>
                    <button class="btn ${link.status === 'online' ? 'btn-green' : 'btn-gray'}" onclick="addInspectedURL('${escapeHtml(link.url)}')">Add</button>
                </div>
            `).join('');
            if (foundLinks.length > displayList.length) {
                elements.inspector.resultList.innerHTML += `<div class="small" style="margin-top:8px;">Results truncated to ${hardCap} entries.</div>`;
            }
        }

        elements.inspector.startBtn.disabled = false;
    }

    // Add inspected URL
    function addInspectedURL(url) {
        const normalizedUrl = normalizeUrl(url);
        if (!normalizedUrl) return false;

        if (!urls.some(u => u.url === normalizedUrl)) {
            urls.push({
                url: normalizedUrl,
                history: [],
                spikes: [],
                tags: [],
                lastCheck: null,
                failCount: 0
            });

            persistUrls();
            render();
            updateTagsList();

            showNotification({
                title: 'URL Added',
                message: `Successfully added ${url} to monitoring`,
                type: 'success'
            });

            return true;
        } else {
            showNotification({
                title: 'URL Exists',
                message: `URL ${url} is already being monitored`,
                type: 'warning'
            });
            return false;
        }
    }

    // Tab Management
    function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(`${tabName}Tab`).classList.add('active');

        // Activate selected tab button
        event.target.classList.add('active');

        // Render specific tab content if needed
        if (tabName === 'alerts') {
            renderAlerts();
        } else if (tabName === 'reports') {
            generateReport();
        } else if (tabName === 'incidents') {
            renderIncidents();
        } else if (tabName === 'integrations') {
            initializeIntegrationSettings();
        } else if (tabName === 'api') {
            initializeApiSettings();
        }
    }

    // Initialize integration settings
    function initializeIntegrationSettings() {
        // Set integration settings values
        document.getElementById('emailEnabled').checked = settings.emailEnabled || false;
        document.getElementById('smtpServer').value = settings.smtpServer || '';
        document.getElementById('smtpPort').value = settings.smtpPort || 587;
        document.getElementById('smtpUsername').value = settings.smtpUsername || '';
        document.getElementById('smtpPassword').value = settings.smtpPassword || '';
        document.getElementById('notificationEmail').value = settings.notificationEmail || '';

        document.getElementById('webhookEnabled').checked = settings.webhookEnabled || false;
        document.getElementById('webhookUrl').value = settings.webhookUrl || '';

        document.getElementById('slackEnabled').checked = settings.slackEnabled || false;
        document.getElementById('slackWebhook').value = settings.slackWebhook || '';
        document.getElementById('slackChannel').value = settings.slackChannel || '';

        // Toggle visibility
        toggleEmailSettings();
        toggleWebhookSettings();
        toggleSlackSettings();
    }

    // Initialize API settings
    function initializeApiSettings() {
        document.getElementById('apiKeyDisplay').textContent = apiKey || 'Generate API key to enable access';
    }

    // Close modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Quick action for showing reports
    function showReports() {
        switchTab('reports');
        generateReport();
    }

    // Initialize the application
    function initializeApp() {
        // Initialize profiles first
        initializeProfiles();

        // Load data for current profile
        settings = { ...DEFAULT_SETTINGS, ...loadFromStorage('settings', {}) };
        urls = loadFromStorage('urls', []);
        alerts = loadFromStorage('alerts', []);
        incidents = loadFromStorage('incidents', []);
        apiKey = loadFromStorage('apiKey', null);

        // Add event listener for login form submission on Enter key
        elements.login.password.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleLogin();
        });

        // Initialize dark mode
        document.body.classList.toggle('dark-mode', settings.darkMode);
        const themeToggle = document.querySelector('.theme-toggle');
        if (themeToggle) {
            themeToggle.textContent = settings.darkMode ? '☀️' : '🌙';
        }

        urls.forEach(u => u.history = prune(u.history, 't'));
        render();
        updateAlertBadge();
        updateTagsList();
        startChecking();
        setupAutoBackup();
    }
</script>
</body>
</html>
